<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.28.4">
    <meta name="project" content="Axon v0.2.0-dev">

    <title>Fashion MNIST Autoencoder — Axon v0.2.0-dev</title>
    <link rel="stylesheet" href="dist/elixir-b6f1ed5df9b1d42a7309.css" />

    <script src="dist/sidebar_items-7edbacc5c8.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/app-bd1cb213813bf4825aa2.js"></script>


  </head>
  <body data-type="extras">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">


<section class="sidebar">
  <button class="sidebar-button sidebar-toggle" aria-label="toggle sidebar">
    <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
  </button>

  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <i class="ri-search-2-line" aria-hidden="true" title="Submit search"></i>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <i class="ri-close-line ri-lg" aria-hidden="true" title="Cancel search"></i>
    </button>
    <label class="search-label">
      <p class="sr-only">Search</p>
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">

      <a href="Axon.html">
        <img src="assets/logo.png" alt="Axon" class="sidebar-projectImage">
      </a>

    <div class="sidebar-projectDetails">
      <a href="Axon.html" class="sidebar-projectName" translate="no">
Axon
      </a>
      <strong class="sidebar-projectVersion" translate="no">
        v0.2.0-dev
      </strong>
    </div>
    <ul class="sidebar-listNav">
      <li><a id="extras-list-link" href="#full-list">Pages</a></li>

        <li><a id="modules-list-link" href="#full-list">Modules</a></li>


    </ul>
  </div>

  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>
<button class="settings display-settings">
  <i class="ri-settings-3-line"></i>
  <span class="sr-only">Settings</span>
</button>


    <a href="https://github.com/elixir-nx/axon/blob/v0.2.0-dev/notebooks/fashionmnist_autoencoder.livemd#L1" title="View Source" class="view-source" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>

  <span>Fashion MNIST Autoencoder</span>
</h1>

  <div class="livebook-badge-container">
    <a href="#" class="livebook-badge">
      <img src="https://livebook.dev/badge/v1/blue.svg" alt="Run in Livebook" width="150" />
    </a>
  </div>

<h2 id="introduction" class="section-heading">
  <a href="#introduction" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">introduction</p>
  </a>
  Introduction
</h2>
<p>An autoencoder is a deep learning model which consists of two parts: encoder and decoder. The encoder compresses high dimensional data into a low dimensional representation and feeds it to the decoder. The decoder tries to recreate the original data from the low dimensional representation.
Autoencoders can be used in the following problems:</p><ul><li>Dimensionality reduction</li><li>Noise reduction</li><li>Generative models</li><li>Data augmentation</li></ul><p>Let's walk through a basic autoencoder implementation in Axon to get a better understanding of how they work in practice.</p><h2 id="imports" class="section-heading">
  <a href="#imports" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">imports</p>
  </a>
  Imports
</h2>
<p>First, we have to import some essential packages. <a href="Axon.html"><code class="inline">Axon</code></a> will be the primary tool to build and train the autoencoder. We also need to import <code class="inline">EXLA</code> for hardware acceleration, <a href="https://hexdocs.pm/nx/0.3.0-dev/Nx.html"><code class="inline">Nx</code></a> for some basic tensor operations, and <code class="inline">Scidata</code> for downloading training data.</p><pre><code class="makeup elixir" translate="no"><span class="nc">Mix</span><span class="o">.</span><span class="n">install</span><span class="p" data-group-id="1098050387-1">(</span><span class="p" data-group-id="1098050387-2">[</span><span class="w">
  </span><span class="p" data-group-id="1098050387-3">{</span><span class="ss">:axon</span><span class="p">,</span><span class="w"> </span><span class="ss">github</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;elixir-nx/axon&quot;</span><span class="p" data-group-id="1098050387-3">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="1098050387-4">{</span><span class="ss">:exla</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.2.2&quot;</span><span class="p" data-group-id="1098050387-4">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="1098050387-5">{</span><span class="ss">:nx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.2.1&quot;</span><span class="p" data-group-id="1098050387-5">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="1098050387-6">{</span><span class="ss">:scidata</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.1.5&quot;</span><span class="p" data-group-id="1098050387-6">}</span><span class="w">
</span><span class="p" data-group-id="1098050387-2">]</span><span class="p" data-group-id="1098050387-1">)</span></code></pre><h2 id="configure-platforms-precedence" class="section-heading">
  <a href="#configure-platforms-precedence" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">configure-platforms-precedence</p>
  </a>
  Configure platforms precedence
</h2>
<p>EXLA provides JIT compilation to hardware accelerators. We'll start by telling EXLA which order of accelerators to use. If you have a specific target in mind, such as <code class="inline">:cuda</code> or <code class="inline">:rocm</code>, you can adjust the precedence to reflect that. The order of precedence here is <code class="inline">tpu</code> &gt; <code class="inline">cuda</code> &gt; <code class="inline">rocm</code> &gt; <code class="inline">host</code>:</p><pre><code class="makeup elixir" translate="no"><span class="nc">EXLA</span><span class="o">.</span><span class="n">set_as_nx_default</span><span class="p" data-group-id="2198128150-1">(</span><span class="p" data-group-id="2198128150-2">[</span><span class="ss">:tpu</span><span class="p">,</span><span class="w"> </span><span class="ss">:cuda</span><span class="p">,</span><span class="w"> </span><span class="ss">:rocm</span><span class="p">,</span><span class="w"> </span><span class="ss">:host</span><span class="p" data-group-id="2198128150-2">]</span><span class="p" data-group-id="2198128150-1">)</span></code></pre><h2 id="downloading-data" class="section-heading">
  <a href="#downloading-data" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">downloading-data</p>
  </a>
  Downloading Data
</h2>
<p>To train and test how our model works, we use one of the most popular data set: MNIST fashion. It consists of small black and white images of clothes. Loading this data set is very simple. Just use <code class="inline">Scidata.FashionMNIST.download()</code>.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">DataSource</span><span class="w"> </span><span class="k" data-group-id="9873407881-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p" data-group-id="9873407881-2">(</span><span class="p" data-group-id="9873407881-2">)</span><span class="w"> </span><span class="k" data-group-id="9873407881-3">do</span><span class="w">
    </span><span class="nc">Scidata.FashionMNIST</span><span class="o">.</span><span class="n">download</span><span class="p" data-group-id="9873407881-4">(</span><span class="p" data-group-id="9873407881-4">)</span><span class="w">
  </span><span class="k" data-group-id="9873407881-3">end</span><span class="w">
</span><span class="k" data-group-id="9873407881-1">end</span></code></pre><h2 id="preprocessing-of-the-images" class="section-heading">
  <a href="#preprocessing-of-the-images" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">preprocessing-of-the-images</p>
  </a>
  Preprocessing of the images
</h2>
<p>The next step is image preprocessing. First, we need to load the training data into tensor using <code class="inline">Nx.from_binary</code> and reshape with <code class="inline">Nx.reshape</code>. Then normalize the data with <code class="inline">Nx.divide</code> and split the dataset into a list of batches with <code class="inline">Nx.to_batched_list</code>.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Preprocessing</span><span class="w"> </span><span class="k" data-group-id="9092580823-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">transform_images</span><span class="p" data-group-id="9092580823-2">(</span><span class="p" data-group-id="9092580823-3">{</span><span class="n">bin</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="p" data-group-id="9092580823-3">}</span><span class="p" data-group-id="9092580823-2">)</span><span class="w"> </span><span class="k" data-group-id="9092580823-4">do</span><span class="w">
    </span><span class="n">bin</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">from_binary</span><span class="p" data-group-id="9092580823-5">(</span><span class="n">type</span><span class="p" data-group-id="9092580823-5">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="9092580823-6">(</span><span class="p" data-group-id="9092580823-7">{</span><span class="n">elem</span><span class="p" data-group-id="9092580823-8">(</span><span class="n">shape</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="9092580823-8">)</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="9092580823-7">}</span><span class="p" data-group-id="9092580823-6">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">divide</span><span class="p" data-group-id="9092580823-9">(</span><span class="mf">255.0</span><span class="p" data-group-id="9092580823-9">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">backend_copy</span><span class="p" data-group-id="9092580823-10">(</span><span class="p" data-group-id="9092580823-10">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_batched_list</span><span class="p" data-group-id="9092580823-11">(</span><span class="mi">32</span><span class="p" data-group-id="9092580823-11">)</span><span class="w">
  </span><span class="k" data-group-id="9092580823-4">end</span><span class="w">
</span><span class="k" data-group-id="9092580823-1">end</span></code></pre><h2 id="encoder-and-decoder" class="section-heading">
  <a href="#encoder-and-decoder" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">encoder-and-decoder</p>
  </a>
  Encoder and decoder
</h2>
<p>First we need to define the encoder and decoder. Both are one-layer neural nets.</p><p>In the encoder, we start by flattening the input using <code class="inline">Axon.flatten</code> because initially, the input shape is {batch_size, 1, 28, 28} and we want to pass the input into a dense layer with <code class="inline">Axon.dense</code>. Our dense layer has only <code class="inline">latent_dim</code> number of neurons. The <code class="inline">latent_dim</code> or latent space is a compressed representation of data. Remember, we want our encoder to compress the input data into a lower-dimensional representation, so we choose a <code class="inline">latent_dim</code> which is less than the dimensionality of the input.</p><p>Next, we pass the output of the encoder to the decoder and try to reconstruct the compressed data into its original form. Since our original input had a dimensionality of 784, we use an <code class="inline">Axon.dense</code> layer with 784 neurons. Because our original data was normalized to have pixel values between 0 and 1, we use a <code class="inline">:sigmoid</code> activation in our dense layer to squeeze output values between 0 and 1. Our original input shape was 28x28, so we use <code class="inline">Axon.reshape</code> to convert the flattened representation of the outputs into an image with correct the width and height.</p><p>If we just bind the encoder and decoder sequentially, we'll get the desired model. This was pretty smooth, wasn't it?</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Autoencoder</span><span class="w"> </span><span class="k" data-group-id="8279388645-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">encoder</span><span class="p" data-group-id="8279388645-2">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">latent_dim</span><span class="p" data-group-id="8279388645-2">)</span><span class="w"> </span><span class="k" data-group-id="8279388645-3">do</span><span class="w">
    </span><span class="n">x</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">flatten</span><span class="p" data-group-id="8279388645-4">(</span><span class="p" data-group-id="8279388645-4">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="8279388645-5">(</span><span class="n">latent_dim</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p" data-group-id="8279388645-5">)</span><span class="w">
  </span><span class="k" data-group-id="8279388645-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">decoder</span><span class="p" data-group-id="8279388645-6">(</span><span class="n">x</span><span class="p" data-group-id="8279388645-6">)</span><span class="w"> </span><span class="k" data-group-id="8279388645-7">do</span><span class="w">
    </span><span class="n">x</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="8279388645-8">(</span><span class="mi">784</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:sigmoid</span><span class="p" data-group-id="8279388645-8">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="8279388645-9">(</span><span class="p" data-group-id="8279388645-10">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="8279388645-10">}</span><span class="p" data-group-id="8279388645-9">)</span><span class="w">
  </span><span class="k" data-group-id="8279388645-7">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">build_model</span><span class="p" data-group-id="8279388645-11">(</span><span class="n">input_shape</span><span class="p">,</span><span class="w"> </span><span class="n">latent_dim</span><span class="p" data-group-id="8279388645-11">)</span><span class="w"> </span><span class="k" data-group-id="8279388645-12">do</span><span class="w">
    </span><span class="nc">Axon</span><span class="o">.</span><span class="n">input</span><span class="p" data-group-id="8279388645-13">(</span><span class="s">&quot;input&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">shape</span><span class="p">:</span><span class="w"> </span><span class="n">input_shape</span><span class="p" data-group-id="8279388645-13">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">encoder</span><span class="p" data-group-id="8279388645-14">(</span><span class="n">latent_dim</span><span class="p" data-group-id="8279388645-14">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">decoder</span><span class="p" data-group-id="8279388645-15">(</span><span class="p" data-group-id="8279388645-15">)</span><span class="w">
  </span><span class="k" data-group-id="8279388645-12">end</span><span class="w">
</span><span class="k" data-group-id="8279388645-1">end</span></code></pre><h2 id="training-the-model" class="section-heading">
  <a href="#training-the-model" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">training-the-model</p>
  </a>
  Training the model
</h2>
<p>Finally, we can train the model. We'll use the <code class="inline">:adam</code> and <code class="inline">:mean_squared_error</code> loss with <code class="inline">Axon.Loop.trainer</code>. Our loss function will measure the aggregate error between pixels of original images and the model's reconstructed images. We'll also <code class="inline">:mean_absolute_error</code> using <code class="inline">Axon.Loop.metric</code>. <code class="inline">Axon.Loop.run</code> trains the model with the given training data.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Trainer</span><span class="w"> </span><span class="k" data-group-id="5383882394-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">train_model</span><span class="p" data-group-id="5383882394-2">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">train_images</span><span class="p">,</span><span class="w"> </span><span class="n">epochs</span><span class="p" data-group-id="5383882394-2">)</span><span class="w"> </span><span class="k" data-group-id="5383882394-3">do</span><span class="w">
    </span><span class="n">model</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">trainer</span><span class="p" data-group-id="5383882394-4">(</span><span class="ss">:mean_squared_error</span><span class="p">,</span><span class="w"> </span><span class="ss">:adam</span><span class="p" data-group-id="5383882394-4">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">metric</span><span class="p" data-group-id="5383882394-5">(</span><span class="ss">:mean_absolute_error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Error&quot;</span><span class="p" data-group-id="5383882394-5">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="5383882394-6">(</span><span class="nc">Stream</span><span class="o">.</span><span class="n">zip</span><span class="p" data-group-id="5383882394-7">(</span><span class="n">train_images</span><span class="p">,</span><span class="w"> </span><span class="n">train_images</span><span class="p" data-group-id="5383882394-7">)</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5383882394-8">%{</span><span class="p" data-group-id="5383882394-8">}</span><span class="p">,</span><span class="w"> </span><span class="ss">epochs</span><span class="p">:</span><span class="w"> </span><span class="n">epochs</span><span class="p">,</span><span class="w"> </span><span class="ss">compiler</span><span class="p">:</span><span class="w"> </span><span class="nc">EXLA</span><span class="p" data-group-id="5383882394-6">)</span><span class="w">
  </span><span class="k" data-group-id="5383882394-3">end</span><span class="w">
</span><span class="k" data-group-id="5383882394-1">end</span></code></pre><p>To better understand what is mean absolute error and mean square error let's go through an example.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Example</span><span class="w"> </span><span class="k" data-group-id="5685991533-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">calculate_mse</span><span class="p" data-group-id="5685991533-2">(</span><span class="n">y_pred</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p" data-group-id="5685991533-2">)</span><span class="w"> </span><span class="k" data-group-id="5685991533-3">do</span><span class="w">
    </span><span class="n">y_pred</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">subtract</span><span class="p" data-group-id="5685991533-4">(</span><span class="n">y</span><span class="p" data-group-id="5685991533-4">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">power</span><span class="p" data-group-id="5685991533-5">(</span><span class="mi">2</span><span class="p" data-group-id="5685991533-5">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">mean</span><span class="p" data-group-id="5685991533-6">(</span><span class="ss">axes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5685991533-7">[</span><span class="o">-</span><span class="mi">1</span><span class="p" data-group-id="5685991533-7">]</span><span class="p" data-group-id="5685991533-6">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">sum</span><span class="p" data-group-id="5685991533-8">(</span><span class="p" data-group-id="5685991533-8">)</span><span class="w">
  </span><span class="k" data-group-id="5685991533-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">calculate_mae</span><span class="p" data-group-id="5685991533-9">(</span><span class="n">y_pred</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p" data-group-id="5685991533-9">)</span><span class="w"> </span><span class="k" data-group-id="5685991533-10">do</span><span class="w">
    </span><span class="n">y_pred</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">subtract</span><span class="p" data-group-id="5685991533-11">(</span><span class="n">y</span><span class="p" data-group-id="5685991533-11">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">abs</span><span class="p" data-group-id="5685991533-12">(</span><span class="p" data-group-id="5685991533-12">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">mean</span><span class="p" data-group-id="5685991533-13">(</span><span class="ss">axes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5685991533-14">[</span><span class="o">-</span><span class="mi">1</span><span class="p" data-group-id="5685991533-14">]</span><span class="p" data-group-id="5685991533-13">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">sum</span><span class="p" data-group-id="5685991533-15">(</span><span class="p" data-group-id="5685991533-15">)</span><span class="w">
  </span><span class="k" data-group-id="5685991533-10">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">run_example</span><span class="w"> </span><span class="k" data-group-id="5685991533-16">do</span><span class="w">
    </span><span class="p" data-group-id="5685991533-17">{</span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="5685991533-17">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DataSource</span><span class="o">.</span><span class="n">get_data</span><span class="p" data-group-id="5685991533-18">(</span><span class="p" data-group-id="5685991533-18">)</span><span class="w">

    </span><span class="n">train_images</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Preprocessing</span><span class="o">.</span><span class="n">transform_images</span><span class="p" data-group-id="5685991533-19">(</span><span class="n">images</span><span class="p" data-group-id="5685991533-19">)</span><span class="w">

    </span><span class="n">shoe_image</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">train_images</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">hd</span><span class="p" data-group-id="5685991533-20">(</span><span class="p" data-group-id="5685991533-20">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">slice_axis</span><span class="p" data-group-id="5685991533-21">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="5685991533-21">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="5685991533-22">(</span><span class="p" data-group-id="5685991533-23">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="5685991533-23">}</span><span class="p" data-group-id="5685991533-22">)</span><span class="w">

    </span><span class="n">noised_shoe_image</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">train_images</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">hd</span><span class="p" data-group-id="5685991533-24">(</span><span class="p" data-group-id="5685991533-24">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">slice_axis</span><span class="p" data-group-id="5685991533-25">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="5685991533-25">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="5685991533-26">(</span><span class="p" data-group-id="5685991533-27">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="5685991533-27">}</span><span class="p" data-group-id="5685991533-26">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">add</span><span class="p" data-group-id="5685991533-28">(</span><span class="nc">Nx</span><span class="o">.</span><span class="n">random_normal</span><span class="p" data-group-id="5685991533-29">(</span><span class="p" data-group-id="5685991533-30">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="5685991533-30">}</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05</span><span class="p" data-group-id="5685991533-29">)</span><span class="p" data-group-id="5685991533-28">)</span><span class="w">

    </span><span class="n">random_image</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">train_images</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p" data-group-id="5685991533-31">(</span><span class="mi">1</span><span class="p" data-group-id="5685991533-31">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">slice_axis</span><span class="p" data-group-id="5685991533-32">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="5685991533-32">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="5685991533-33">(</span><span class="p" data-group-id="5685991533-34">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="5685991533-34">}</span><span class="p" data-group-id="5685991533-33">)</span><span class="w">

    </span><span class="n">same_images_mse_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculate_mse</span><span class="p" data-group-id="5685991533-35">(</span><span class="n">shoe_image</span><span class="p">,</span><span class="w"> </span><span class="n">shoe_image</span><span class="p" data-group-id="5685991533-35">)</span><span class="w">
    </span><span class="n">similar_images_mse_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculate_mse</span><span class="p" data-group-id="5685991533-36">(</span><span class="n">shoe_image</span><span class="p">,</span><span class="w"> </span><span class="n">noised_shoe_image</span><span class="p" data-group-id="5685991533-36">)</span><span class="w">
    </span><span class="n">different_images_mse_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculate_mse</span><span class="p" data-group-id="5685991533-37">(</span><span class="n">shoe_image</span><span class="p">,</span><span class="w"> </span><span class="n">random_image</span><span class="p" data-group-id="5685991533-37">)</span><span class="w">

    </span><span class="n">same_images_mae_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculate_mae</span><span class="p" data-group-id="5685991533-38">(</span><span class="n">shoe_image</span><span class="p">,</span><span class="w"> </span><span class="n">shoe_image</span><span class="p" data-group-id="5685991533-38">)</span><span class="w">
    </span><span class="n">similar_images_mae_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculate_mae</span><span class="p" data-group-id="5685991533-39">(</span><span class="n">shoe_image</span><span class="p">,</span><span class="w"> </span><span class="n">noised_shoe_image</span><span class="p" data-group-id="5685991533-39">)</span><span class="w">
    </span><span class="n">different_images_mae_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculate_mae</span><span class="p" data-group-id="5685991533-40">(</span><span class="n">shoe_image</span><span class="p">,</span><span class="w"> </span><span class="n">random_image</span><span class="p" data-group-id="5685991533-40">)</span><span class="w">

    </span><span class="p" data-group-id="5685991533-41">%{</span><span class="w">
      </span><span class="ss">same</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5685991533-42">{</span><span class="p" data-group-id="5685991533-43">[</span><span class="ss">mse</span><span class="p">:</span><span class="w"> </span><span class="n">same_images_mse_error</span><span class="p" data-group-id="5685991533-43">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5685991533-44">[</span><span class="ss">mae</span><span class="p">:</span><span class="w"> </span><span class="n">same_images_mae_error</span><span class="p" data-group-id="5685991533-44">]</span><span class="p" data-group-id="5685991533-42">}</span><span class="p">,</span><span class="w">
      </span><span class="ss">similar</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5685991533-45">{</span><span class="p" data-group-id="5685991533-46">[</span><span class="ss">mse</span><span class="p">:</span><span class="w"> </span><span class="n">similar_images_mse_error</span><span class="p" data-group-id="5685991533-46">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5685991533-47">[</span><span class="ss">mae</span><span class="p">:</span><span class="w"> </span><span class="n">similar_images_mae_error</span><span class="p" data-group-id="5685991533-47">]</span><span class="p" data-group-id="5685991533-45">}</span><span class="p">,</span><span class="w">
      </span><span class="ss">different</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5685991533-48">{</span><span class="p" data-group-id="5685991533-49">[</span><span class="ss">mse</span><span class="p">:</span><span class="w"> </span><span class="n">different_images_mse_error</span><span class="p" data-group-id="5685991533-49">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5685991533-50">[</span><span class="ss">mae</span><span class="p">:</span><span class="w"> </span><span class="n">different_images_mae_error</span><span class="p" data-group-id="5685991533-50">]</span><span class="p" data-group-id="5685991533-48">}</span><span class="w">
    </span><span class="p" data-group-id="5685991533-41">}</span><span class="w">
  </span><span class="k" data-group-id="5685991533-16">end</span><span class="w">
</span><span class="k" data-group-id="5685991533-1">end</span><span class="w">

</span><span class="nc">Example</span><span class="o">.</span><span class="n">run_example</span><span class="p" data-group-id="5685991533-51">(</span><span class="p" data-group-id="5685991533-51">)</span></code></pre><p>We choose an image of a shoe as a reference. As we can see, the error for the same picture is 0 (both mae and mse). Indeed, when we have two exact copies, there is no pixel with different values, and the error is equal to zero. Noised image has a non-zero mse and mae but is much smaller than the error of two completely different pictures. This fact indicates the level of similarity between images. The small error implies decent prediction values. On the other hand, a large value of loss suggests poor quality of predictions.</p><h2 id="evaluation-of-the-model" class="section-heading">
  <a href="#evaluation-of-the-model" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">evaluation-of-the-model</p>
  </a>
  Evaluation of the model
</h2>
<pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Evaluation</span><span class="w"> </span><span class="k" data-group-id="2692330499-1">do</span><span class="w">
  </span><span class="kn">require</span><span class="w"> </span><span class="nc">Axon</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">run</span><span class="w"> </span><span class="k" data-group-id="2692330499-2">do</span><span class="w">
    </span><span class="p" data-group-id="2692330499-3">{</span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="2692330499-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DataSource</span><span class="o">.</span><span class="n">get_data</span><span class="p" data-group-id="2692330499-4">(</span><span class="p" data-group-id="2692330499-4">)</span><span class="w">

    </span><span class="n">train_images</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Preprocessing</span><span class="o">.</span><span class="n">transform_images</span><span class="p" data-group-id="2692330499-5">(</span><span class="n">images</span><span class="p" data-group-id="2692330499-5">)</span><span class="w">

    </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Autoencoder</span><span class="o">.</span><span class="n">build_model</span><span class="p" data-group-id="2692330499-6">(</span><span class="p" data-group-id="2692330499-7">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="2692330499-7">}</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p" data-group-id="2692330499-6">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="2692330499-8">(</span><span class="p" data-group-id="2692330499-8">)</span><span class="w">

    </span><span class="n">model_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Trainer</span><span class="o">.</span><span class="n">train_model</span><span class="p" data-group-id="2692330499-9">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">train_images</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="2692330499-9">)</span><span class="w">

    </span><span class="n">sample_image</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">train_images</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">hd</span><span class="p" data-group-id="2692330499-10">(</span><span class="p" data-group-id="2692330499-10">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">slice_axis</span><span class="p" data-group-id="2692330499-11">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="2692330499-11">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="2692330499-12">(</span><span class="p" data-group-id="2692330499-13">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="2692330499-13">}</span><span class="p" data-group-id="2692330499-12">)</span><span class="w">

    </span><span class="n">sample_image</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_heatmap</span><span class="p" data-group-id="2692330499-14">(</span><span class="p" data-group-id="2692330499-14">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="2692330499-15">(</span><span class="p" data-group-id="2692330499-15">)</span><span class="w">

    </span><span class="n">model</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">predict</span><span class="p" data-group-id="2692330499-16">(</span><span class="n">model_state</span><span class="p">,</span><span class="w"> </span><span class="n">sample_image</span><span class="p">,</span><span class="w"> </span><span class="ss">compiler</span><span class="p">:</span><span class="w"> </span><span class="nc">EXLA</span><span class="p" data-group-id="2692330499-16">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_heatmap</span><span class="p" data-group-id="2692330499-17">(</span><span class="p" data-group-id="2692330499-17">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="2692330499-18">(</span><span class="p" data-group-id="2692330499-18">)</span><span class="w">
  </span><span class="k" data-group-id="2692330499-2">end</span><span class="w">
</span><span class="k" data-group-id="2692330499-1">end</span></code></pre><h2 id="results-analysis" class="section-heading">
  <a href="#results-analysis" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">results-analysis</p>
  </a>
  Results analysis
</h2>
<p>As we can see, the generated image is similar to the input image. The only difference between them is the absence of a sign in the middle of the second shoe. The model treated the sign as noise and bled this into the plain shoe. To get the outputs run <a href="https://github.com/elixir-nx/axon/blob/main/examples/generative/fashionmnist_autoencoder.exs" title="Elixir module with Autoencoder">this code</a>.</p><pre><code class="makeup elixir" translate="no"><span class="nc">Evaluation</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="0932922693-1">(</span><span class="p" data-group-id="0932922693-1">)</span></code></pre>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="mnist.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
MNIST
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="multi_input_example.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Multi Input Models
        </span>
      </a>

  </div>
</div>

      <footer class="footer">

          <p>
            On Hex.pm:

            <span class="line">
              <a href="https://hex.pm/packages/axon/0.2.0-dev" class="line footer-hex-package">Package</a>
              <a href="https://preview.hex.pm/preview/axon/0.2.0-dev" class="line">Preview</a>

                <a href="https://preview.hex.pm/preview/axon/0.2.0-dev/show/notebooks/fashionmnist_autoencoder.livemd">(current file)</a>

            </span>

            <button class="line footer-button display-quick-switch">
              Search
            </button>
          </p>

        <p>
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.28.4) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</section>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css" integrity="sha384-t5CR+zwDAROtph0PXGte6ia8heboACF9R5l/DiY+WZ3P2lxNgvJkQk5n7GPvLMYw" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js" integrity="sha384-FaFLTlohFghEIZkw6VGwmf9ISTubWAVYW8tG8+w2LAIftJEULZABrF9PPFv+tVkH" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js" integrity="sha384-bHBqxz8fokvgoJ/sc17HODNxa42TlaEhB+w8ZJXTc2nZf1VgEaFZeZvT4Mznfz0v" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>

  </body>
</html>
