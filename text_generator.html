<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.28.5">
    <meta name="project" content="Axon v0.2.0">

    <title>Generating text with an LSTM — Axon v0.2.0</title>
    <link rel="stylesheet" href="dist/elixir-64c5e2b63575bddb1c5b.css" />

    <script src="dist/sidebar_items-6168b73512.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/app-b5f3440501744dc8be3d.js"></script>


  </head>
  <body data-type="extras">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">


<section class="sidebar">
  <button class="sidebar-button sidebar-toggle" aria-label="toggle sidebar">
    <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
  </button>

  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <i class="ri-search-2-line" aria-hidden="true" title="Submit search"></i>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <i class="ri-close-line ri-lg" aria-hidden="true" title="Cancel search"></i>
    </button>
    <label class="search-label">
      <p class="sr-only">Search</p>
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">

      <a href="Axon.html">
        <img src="assets/logo.png" alt="Axon" class="sidebar-projectImage">
      </a>

    <div class="sidebar-projectDetails">
      <a href="Axon.html" class="sidebar-projectName" translate="no">
Axon
      </a>
      <strong class="sidebar-projectVersion" translate="no">
        v0.2.0
      </strong>
    </div>
    <ul class="sidebar-listNav">
      <li><a id="extras-list-link" href="#full-list">Pages</a></li>

        <li><a id="modules-list-link" href="#full-list">Modules</a></li>


    </ul>
  </div>

  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>
<button class="settings display-settings">
  <i class="ri-settings-3-line"></i>
  <span class="sr-only">Settings</span>
</button>


    <a href="https://github.com/elixir-nx/axon/blob/v0.2.0/notebooks/text/text_generator.livemd#L1" title="View Source" class="view-source" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>

  <span>Generating text with an LSTM</span>
</h1>

  <div class="livebook-badge-container">
    <a href="#" class="livebook-badge">
      <img src="https://livebook.dev/badge/v1/blue.svg" alt="Run in Livebook" width="150" />
    </a>
  </div>

<pre><code class="makeup elixir" translate="no"><span class="nc">Mix</span><span class="o">.</span><span class="n">install</span><span class="p" data-group-id="4345357454-1">(</span><span class="p" data-group-id="4345357454-2">[</span><span class="w">
  </span><span class="p" data-group-id="4345357454-3">{</span><span class="ss">:axon</span><span class="p">,</span><span class="w"> </span><span class="ss">github</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;elixir-nx/axon&quot;</span><span class="p" data-group-id="4345357454-3">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="4345357454-4">{</span><span class="ss">:nx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.2.1&quot;</span><span class="p" data-group-id="4345357454-4">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="4345357454-5">{</span><span class="ss">:exla</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.2.2&quot;</span><span class="p" data-group-id="4345357454-5">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="4345357454-6">{</span><span class="ss">:req</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.3.0&quot;</span><span class="p" data-group-id="4345357454-6">}</span><span class="w">
</span><span class="p" data-group-id="4345357454-2">]</span><span class="p" data-group-id="4345357454-1">)</span><span class="w">

</span><span class="nc">EXLA</span><span class="o">.</span><span class="n">set_as_nx_default</span><span class="p" data-group-id="4345357454-7">(</span><span class="p" data-group-id="4345357454-8">[</span><span class="ss">:tpu</span><span class="p">,</span><span class="w"> </span><span class="ss">:cuda</span><span class="p">,</span><span class="w"> </span><span class="ss">:rocm</span><span class="p">,</span><span class="w"> </span><span class="ss">:host</span><span class="p" data-group-id="4345357454-8">]</span><span class="p" data-group-id="4345357454-7">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="ss">:cuda</span></code></pre><h2 id="recurrent-neural-networks-as-generative-models" class="section-heading">
  <a href="#recurrent-neural-networks-as-generative-models" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">recurrent-neural-networks-as-generative-models</p>
  </a>
  Recurrent Neural Networks as generative models
</h2>
<p>Recurrent neural networks can also be used as generative models.</p><p>This means that in addition to being used for predictive models (making predictions) they can learn the sequences of a problem and then generate entirely new plausible sequences for the problem domain.</p><p>Generative models like this are useful not only to study how well a model has learned a problem, but to learn more about the problem domain itself.</p><p>In this example, we will discover how to create a generative model for text, character-by-character using LSTM recurrent neural networks in Elixir with Axon.</p><h2 id="preparation" class="section-heading">
  <a href="#preparation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">preparation</p>
  </a>
  Preparation
</h2>
<p>Using <a href="https://www.gutenberg.org/">Project Gutenburg</a> we can download a text book which is no longer protected under copywrite so we can experiment with them.</p><p>The one that we will use for this experiment is <a href="https://www.gutenberg.org/ebooks/11">Alice's Adventures in Wonderland by Lewis Carroll</a>. You can choose any other text or book that you like for this experiment.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># change download_url if you like to experiment with other text books.</span><span class="w">
</span><span class="n">download_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;https://www.gutenberg.org/files/11/11-0.txt&quot;</span><span class="w">

</span><span class="n">book_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Req</span><span class="o">.</span><span class="n">get!</span><span class="p" data-group-id="5186427319-1">(</span><span class="n">download_url</span><span class="p" data-group-id="5186427319-1">)</span><span class="o">.</span><span class="n">body</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="s">&quot;</span><span class="se">\uFEFF</span><span class="s">The Project Gutenberg eBook of Alice’s Adventures in Wonderland, by Lewis Carroll</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">This eBook is for the use of anyone anywhere in the United States and</span><span class="se">\r</span><span class="se">\n</span><span class="s">most other parts of the world at no cost and with almost no restrictions</span><span class="se">\r</span><span class="se">\n</span><span class="s">whatsoever. You may copy it, give it away or re-use it under the terms</span><span class="se">\r</span><span class="se">\n</span><span class="s">of the Project Gutenberg License included with this eBook or online at</span><span class="se">\r</span><span class="se">\n</span><span class="s">www.gutenberg.org. If you are not located in the United States, you</span><span class="se">\r</span><span class="se">\n</span><span class="s">will have to check the laws of the country where you are located before</span><span class="se">\r</span><span class="se">\n</span><span class="s">using this eBook.</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">Title: Alice’s Adventures in Wonderland</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">Author: Lewis Carroll</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">Release Date: January, 1991 [eBook #11]</span><span class="se">\r</span><span class="se">\n</span><span class="s">[Most recently updated: October 12, 2020]</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">Language: English</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">Character set encoding: UTF-8</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">Produced by: Arthur DiBianca and David Widger</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">*** START OF THE PROJECT GUTENBERG EBOOK ALICE’S ADVENTURES IN WONDERLAND ***</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">[Illustration]</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">Alice’s Adventures in Wonderland</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">by Lewis Carroll</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">THE MILLENNIUM FULCRUM EDITION 3.0</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">Contents</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s"> CHAPTER I.     Down the Rabbit-Hole</span><span class="se">\r</span><span class="se">\n</span><span class="s"> CHAPTER II.    The Pool of Tears</span><span class="se">\r</span><span class="se">\n</span><span class="s"> CHAPTER III.   A Caucus-Race and a Long Tale</span><span class="se">\r</span><span class="se">\n</span><span class="s"> CHAPTER IV.    The Rabbit Sends in a Little Bill</span><span class="se">\r</span><span class="se">\n</span><span class="s"> CHAPTER V.     Advice from a Caterpillar</span><span class="se">\r</span><span class="se">\n</span><span class="s"> CHAPTER VI.    Pig and Pepper</span><span class="se">\r</span><span class="se">\n</span><span class="s"> CHAPTER VII.   A Mad Tea-Party</span><span class="se">\r</span><span class="se">\n</span><span class="s"> CHAPTER VIII.  The Queen’s Croquet-Ground</span><span class="se">\r</span><span class="se">\n</span><span class="s"> CHAPTER IX.    The Mock Turtle’s Story</span><span class="se">\r</span><span class="se">\n</span><span class="s"> CHAPTER X.     The Lobster Quadrille</span><span class="se">\r</span><span class="se">\n</span><span class="s"> CHAPTER XI.    Who Stole the Tarts?</span><span class="se">\r</span><span class="se">\n</span><span class="s"> CHAPTER XII.   Alice’s Evidence</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">CHAPTER I.</span><span class="se">\r</span><span class="se">\n</span><span class="s">Down the Rabbit-Hole</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">Alice was beginning to get very tired of sitting by her sister on the</span><span class="se">\r</span><span class="se">\n</span><span class="s">bank, and of having nothing to do: once or twice she had peeped into</span><span class="se">\r</span><span class="se">\n</span><span class="s">the book her sister was reading, but it had no pictures or</span><span class="se">\r</span><span class="se">\n</span><span class="s">conversations in it, “and what is the use of a book,” thought Alice</span><span class="se">\r</span><span class="se">\n</span><span class="s">“without pictures or conversations?”</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">So she was considering in her own mind (as well as she could, for the</span><span class="se">\r</span><span class="se">\n</span><span class="s">hot day made her feel very sleepy and stupid), whether the pleasure of</span><span class="se">\r</span><span class="se">\n</span><span class="s">making a daisy-chain would be worth the trouble of getting up and</span><span class="se">\r</span><span class="se">\n</span><span class="s">picking the daisies, when suddenly a White Rabbit with pink eyes ran</span><span class="se">\r</span><span class="se">\n</span><span class="s">close by her.</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">There was nothing so _very_ remarkable in that; nor did Alice think it</span><span class="se">\r</span><span class="se">\n</span><span class="s">so _very_ much out of the way to hear the Rabbit say to itself, “Oh</span><span class="se">\r</span><span class="se">\n</span><span class="s">dear! Oh dear! I shall be late!” (when she thought it over afterwards,</span><span class="se">\r</span><span class="se">\n</span><span class="s">it occurred to her that she ought to have wondered at this, but at the</span><span class="se">\r</span><span class="se">\n</span><span class="s">time it all seemed quite natural); but when the Rabbit actually _took a</span><span class="se">\r</span><span class="se">\n</span><span class="s">watch out of its waistcoat-pocket_, and looked at it, and then hurried</span><span class="se">\r</span><span class="se">\n</span><span class="s">on, Alice started to her feet, for it flashed across her mind that she</span><span class="se">\r</span><span class="se">\n</span><span class="s">had never before seen a rabbit with either a waistcoat-pocket, or a</span><span class="se">\r</span><span class="se">\n</span><span class="s">watch to take out of it, and burning with curiosity, she ran across the</span><span class="se">\r</span><span class="se">\n</span><span class="s">field after it, and fortunately was just in time to see it pop down a</span><span class="se">\r</span><span class="se">\n</span><span class="s">large rabbit-hole under the hedge.</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">In another moment down went Alice after it, never once considering how</span><span class="se">\r</span><span class="se">\n</span><span class="s">in the world she was to get out again.</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">The rabbit-hole went straight on like a tunnel for some way, and then</span><span class="se">\r</span><span class="se">\n</span><span class="s">dipped suddenly down, so suddenly that Alice had not a moment to think</span><span class="se">\r</span><span class="se">\n</span><span class="s">about stopping herself before she found herself falling down a very</span><span class="se">\r</span><span class="se">\n</span><span class="s">deep well.</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">Either the well was very deep, or she fell very slowly, for she had</span><span class="se">\r</span><span class="se">\n</span><span class="s">plenty of time as she went down to look about her and to wonder what</span><span class="se">\r</span><span class="se">\n</span><span class="s">was going to happen next. First, she tried to look down and make out</span><span class="se">\r</span><span class="se">\n</span><span class="s">what she was coming to, but it was too dark to see anything; then she</span><span class="se">\r</span><span class="se">\n</span><span class="s">looked at the sides of the well, and noticed that they were filled with</span><span class="se">\r</span><span class="se">\n</span><span class="s">cupboards and book-shelves; here and there she saw maps and pictures</span><span class="se">\r</span><span class="se">\n</span><span class="s">hung upon pegs. She took down a jar from one of the shelves as she</span><span class="se">\r</span><span class="se">\n</span><span class="s">passed; it was labelled “ORANGE MARMALADE”, but to her great</span><span class="se">\r</span><span class="se">\n</span><span class="s">disappointment it was empty: she did not like to drop the jar for fear</span><span class="se">\r</span><span class="se">\n</span><span class="s">of killing somebody underneath, so managed to put it into one of the</span><span class="se">\r</span><span class="se">\n</span><span class="s">cupboards as she fell past it.</span><span class="se">\r</span><span class="se">\n</span><span class="se">\r</span><span class="se">\n</span><span class="s">“Well!” thought Alice to herself, “after such a fall as this, I shall</span><span class="se">\r</span><span class="se">\n</span><span class="s">think nothing of tumbling down stairs! How brave they’ll all think me&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">...</span></code></pre><p>First of all, we need to normalize the content of the book. We are only interested in the sequence of English characters, periods and new lines. Also currently we don't care about the capitalization and things like apostrophe so we can remove all other unknown characters and downcase everything. We can use a regular expression for that.</p><p>We can also convert the string into a list of characters so we can handle them easier. You will understand exactly why a bit further.</p><pre><code class="makeup elixir" translate="no"><span class="n">normalized_book_text</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">book_text</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">downcase</span><span class="p" data-group-id="9771984880-1">(</span><span class="p" data-group-id="9771984880-1">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">replace</span><span class="p" data-group-id="9771984880-2">(</span><span class="sr">~r/[^a-z </span><span class="se">\.</span><span class="se">\n</span><span class="sr">]/</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p" data-group-id="9771984880-2">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">to_charlist</span><span class="p" data-group-id="9771984880-3">(</span><span class="p" data-group-id="9771984880-3">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="sc">&#39;the project gutenberg ebook of alices adventures in wonderland by lewis carroll</span><span class="se">\n</span><span class="se">\n</span><span class="sc">this ebook is for the use of anyone anywhere in the united states and</span><span class="se">\n</span><span class="sc">most other parts of the world at no cost and with almost no restrictions</span><span class="se">\n</span><span class="sc">whatsoever. you may copy it give it away or reuse it under the terms</span><span class="se">\n</span><span class="sc">of the project gutenberg license included with this ebook or online at</span><span class="se">\n</span><span class="sc">www.gutenberg.org. if you are not located in the united states you</span><span class="se">\n</span><span class="sc">will have to check the laws of the country where you are located before</span><span class="se">\n</span><span class="sc">using this ebook.</span><span class="se">\n</span><span class="se">\n</span><span class="sc">title alices adventures in wonderland</span><span class="se">\n</span><span class="se">\n</span><span class="sc">author lewis carroll</span><span class="se">\n</span><span class="se">\n</span><span class="sc">release date january  ebook </span><span class="se">\n</span><span class="sc">most recently updated october  </span><span class="se">\n</span><span class="se">\n</span><span class="sc">language english</span><span class="se">\n</span><span class="se">\n</span><span class="sc">character set encoding utf</span><span class="se">\n</span><span class="se">\n</span><span class="sc">produced by arthur dibianca and david widger</span><span class="se">\n</span><span class="se">\n</span><span class="sc"> start of the project gutenberg ebook alices adventures in wonderland </span><span class="se">\n</span><span class="se">\n</span><span class="sc">illustration</span><span class="se">\n</span><span class="se">\n</span><span class="se">\n</span><span class="se">\n</span><span class="se">\n</span><span class="sc">alices adventures in wonderland</span><span class="se">\n</span><span class="se">\n</span><span class="sc">by lewis carroll</span><span class="se">\n</span><span class="se">\n</span><span class="sc">the millennium fulcrum edition .</span><span class="se">\n</span><span class="se">\n</span><span class="sc">contents</span><span class="se">\n</span><span class="se">\n</span><span class="sc"> chapter i.     down the rabbithole</span><span class="se">\n</span><span class="sc"> chapter ii.    the pool of tears</span><span class="se">\n</span><span class="sc"> chapter iii.   a caucusrace and a long tale</span><span class="se">\n</span><span class="sc"> chapter iv.    the rabbit sends in a little bill</span><span class="se">\n</span><span class="sc"> chapter v.     advice from a caterpillar</span><span class="se">\n</span><span class="sc"> chapter vi.    pig and pepper</span><span class="se">\n</span><span class="sc"> chapter vii.   a mad teaparty</span><span class="se">\n</span><span class="sc"> chapter viii.  the queens croquetground</span><span class="se">\n</span><span class="sc"> chapter ix.    the mock turtles story</span><span class="se">\n</span><span class="sc"> chapter x.     the lobster quadrille</span><span class="se">\n</span><span class="sc"> chapter xi.    who stole the tarts</span><span class="se">\n</span><span class="sc"> chapter xii.   alices evidence</span><span class="se">\n</span><span class="se">\n</span><span class="se">\n</span><span class="se">\n</span><span class="se">\n</span><span class="sc">chapter i.</span><span class="se">\n</span><span class="sc">down the rabbithole</span><span class="se">\n</span><span class="se">\n</span><span class="se">\n</span><span class="sc">alice was beginning to get very tired of sitting by her sister on the</span><span class="se">\n</span><span class="sc">bank and of having nothing to do once or twice she had peeped into</span><span class="se">\n</span><span class="sc">the book her sister was reading but it had no pictures or</span><span class="se">\n</span><span class="sc">conversations in it and what is the use of a book thought alice</span><span class="se">\n</span><span class="sc">without pictures or conversations</span><span class="se">\n</span><span class="se">\n</span><span class="sc">so she was considering in her own mind as well as she could for the</span><span class="se">\n</span><span class="sc">hot day made her feel very sleepy and stupid whether the pleasure of</span><span class="se">\n</span><span class="sc">making a daisychain would be worth the trouble of getting up and</span><span class="se">\n</span><span class="sc">picking the daisies when suddenly a white rabbit with pink eyes ran</span><span class="se">\n</span><span class="sc">close by her.</span><span class="se">\n</span><span class="se">\n</span><span class="sc">there was nothing so very remarkable in that nor did alice think it</span><span class="se">\n</span><span class="sc">so very much out of the way to hear the rabbit say to itself oh</span><span class="se">\n</span><span class="sc">dear oh dear i shall be late when she thought it over afterwards</span><span class="se">\n</span><span class="sc">it occurred to her that she ought to have wondered at this but at the</span><span class="se">\n</span><span class="sc">time it all seemed quite natural but when the rabbit actually took a</span><span class="se">\n</span><span class="sc">watch out of its waistcoatpocket and looked at it and then hurried</span><span class="se">\n</span><span class="sc">on alice started to her feet for it flashed across her mind that she</span><span class="se">\n</span><span class="sc">had never before seen a rabbit with either a waistcoatpocket or a</span><span class="se">\n</span><span class="sc">watch to take out of it and burning with curiosity she ran across the</span><span class="se">\n</span><span class="sc">field after it and fortunately was just in time to see it pop down a</span><span class="se">\n</span><span class="sc">large rabbithole under the hedge.</span><span class="se">\n</span><span class="se">\n</span><span class="sc">in another moment down went alice after it never once considering how</span><span class="se">\n</span><span class="sc">in the world she was to get out again.</span><span class="se">\n</span><span class="se">\n</span><span class="sc">the rabbithole went straight on like a tunnel for some way and then</span><span class="se">\n</span><span class="sc">dipped suddenly down so suddenly that alice had not a moment to think</span><span class="se">\n</span><span class="sc">about stopping herself before she found herself falling down a very</span><span class="se">\n</span><span class="sc">deep well.</span><span class="se">\n</span><span class="se">\n</span><span class="sc">either the well was very deep or she fell very slowly for she had</span><span class="se">\n</span><span class="sc">plenty of time as she went down to look about her and to wonder what</span><span class="se">\n</span><span class="sc">was going to happen next. first she tried to look down and make out</span><span class="se">\n</span><span class="sc">what she was coming to but it was too dark to see anything then she</span><span class="se">\n</span><span class="sc">looked at the sides of the well and noticed that they were filled with</span><span class="se">\n</span><span class="sc">cupboards and bookshelves here and there she saw maps and pictures</span><span class="se">\n</span><span class="sc">hung upon pegs. she took down a jar from one of the shelves as she</span><span class="se">\n</span><span class="sc">passed it was labelled orange marmalade but to her great</span><span class="se">\n</span><span class="sc">disappointment it was empty she did not like to drop the jar for fear</span><span class="se">\n</span><span class="sc">of killing somebody underneath so managed to put it into one of the</span><span class="se">\n</span><span class="sc">cupboards as she fell past it.</span><span class="se">\n</span><span class="se">\n</span><span class="sc">well thought alice to herself after such a fall as this i shall</span><span class="se">\n</span><span class="sc">think nothing of tumbling down stairs how brave theyll all think me</span><span class="se">\n</span><span class="sc">at home why i wouldnt say anything about it even if i fell off the</span><span class="se">\n</span><span class="sc">top of the house which was very likely true.</span><span class="se">\n</span><span class="se">\n</span><span class="sc">down down down. would the fall never come to an end i wonder how</span><span class="se">\n</span><span class="sc">many miles ive fallen by this time she said aloud. &#39;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">...</span></code></pre><p>We converted the text to a list of characters, where each character is a number (specifically, a Unicode code point). Lowercase English characters are represented with numbers between <code class="inline">97 = a</code> and <code class="inline">122 = z</code>, a space is <code class="inline">32 = [ ]</code>, a new line is <code class="inline">10 = \n</code> and the period is <code class="inline">46 = .</code>.</p><p>So we should have 26 + 3 (= 29) characters in total. Let's see if that's true.</p><pre><code class="makeup elixir" translate="no"><span class="nc">Enum</span><span class="o">.</span><span class="n">uniq</span><span class="p" data-group-id="8357713343-1">(</span><span class="n">normalized_book_text</span><span class="p" data-group-id="8357713343-1">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">count</span><span class="p" data-group-id="8357713343-2">(</span><span class="p" data-group-id="8357713343-2">)</span><span class="w">
</span><span class="c1"># Yay!</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="mi">29</span></code></pre><p>Since we want to use this 29 characters as possible values for each input in our neural network, We can re-map them to new values between 0 and 28. So each specific neuron will indicate a specific character.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># Extract all then unique characters we have. Optionally we can sort them.</span><span class="w">
</span><span class="n">characters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalized_book_text</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">uniq</span><span class="p" data-group-id="6500104506-1">(</span><span class="p" data-group-id="6500104506-1">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">sort</span><span class="p" data-group-id="6500104506-2">(</span><span class="p" data-group-id="6500104506-2">)</span><span class="w">
</span><span class="n">characters_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">count</span><span class="p" data-group-id="6500104506-3">(</span><span class="n">characters</span><span class="p" data-group-id="6500104506-3">)</span><span class="w">

</span><span class="c1"># Create a mapping for every character</span><span class="w">
</span><span class="n">char_to_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">with_index</span><span class="p" data-group-id="6500104506-4">(</span><span class="n">characters</span><span class="p" data-group-id="6500104506-4">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">into</span><span class="p" data-group-id="6500104506-5">(</span><span class="p" data-group-id="6500104506-6">%{</span><span class="p" data-group-id="6500104506-6">}</span><span class="p" data-group-id="6500104506-5">)</span><span class="w">
</span><span class="c1"># And a reverse mapping to convert back to characters</span><span class="w">
</span><span class="n">idx_to_char</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">with_index</span><span class="p" data-group-id="6500104506-7">(</span><span class="n">characters</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p" data-group-id="6500104506-8">{</span><span class="ni">&amp;2</span><span class="p">,</span><span class="w"> </span><span class="ni">&amp;1</span><span class="p" data-group-id="6500104506-8">}</span><span class="p" data-group-id="6500104506-7">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">into</span><span class="p" data-group-id="6500104506-9">(</span><span class="p" data-group-id="6500104506-10">%{</span><span class="p" data-group-id="6500104506-10">}</span><span class="p" data-group-id="6500104506-9">)</span><span class="w">

</span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="6500104506-11">(</span><span class="s">&quot;Total Book Characters: </span><span class="si" data-group-id="6500104506-12">#{</span><span class="nc">Enum</span><span class="o">.</span><span class="n">count</span><span class="p" data-group-id="6500104506-13">(</span><span class="n">normalized_book_text</span><span class="p" data-group-id="6500104506-13">)</span><span class="si" data-group-id="6500104506-12">}</span><span class="s">&quot;</span><span class="p" data-group-id="6500104506-11">)</span><span class="w">
</span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="6500104506-14">(</span><span class="s">&quot;Total Unique Characters: </span><span class="si" data-group-id="6500104506-15">#{</span><span class="n">characters_count</span><span class="si" data-group-id="6500104506-15">}</span><span class="s">&quot;</span><span class="p" data-group-id="6500104506-14">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="nc">Total</span><span class="w"> </span><span class="nc">Book</span><span class="w"> </span><span class="ss">Characters</span><span class="p">:</span><span class="w"> </span><span class="mi">156020</span><span class="w">
</span><span class="nc">Total</span><span class="w"> </span><span class="nc">Unique</span><span class="w"> </span><span class="ss">Characters</span><span class="p">:</span><span class="w"> </span><span class="mi">29</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="ss">:ok</span></code></pre><p>Now we need to create our training and testing data sets. But how?</p><p>Our goal is to teach the machine what comes after a sequence of characters (usually). For example given the following sequence <strong>&quot;Hello, My name i&quot;</strong> the computer should be able to guess that the next character is probably <strong>&quot;s&quot;</strong>.</p><pre><code class="mermaid">graph LR;
  A[Input: Hello my name i]--&gt;NN[Neural Network]--&gt;B[Output: s];</code></pre><p>Let's choose an arbitrary sequence length and create a data set from the book text. All we need to do is read X amount of characters from the book as the input and then read 1 more as the designated output.</p><p>After doing all that, we also want to convert every character to it's index using the <code class="inline">char_to_idx</code> mapping that we have created before.</p><p>Neural networks work best if you scale your inputs and outputs. In this case we are going to scale everything between 0 and 1 by dividing them by the number of unique characters that we have.</p><p>And for the final step we will reshape it so we can use the data in our LSTM model.</p><pre><code class="makeup elixir" translate="no"><span class="n">sequence_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w">

</span><span class="n">train_data</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">normalized_book_text</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="8970986292-1">(</span><span class="o">&amp;</span><span class="nc">Map</span><span class="o">.</span><span class="n">fetch!</span><span class="p" data-group-id="8970986292-2">(</span><span class="n">char_to_idx</span><span class="p">,</span><span class="w"> </span><span class="ni">&amp;1</span><span class="p" data-group-id="8970986292-2">)</span><span class="p" data-group-id="8970986292-1">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">chunk_every</span><span class="p" data-group-id="8970986292-3">(</span><span class="n">sequence_length</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">:discard</span><span class="p" data-group-id="8970986292-3">)</span><span class="w">
  </span><span class="c1"># We don&#39;t want the last chunk since we don&#39;t have a prediction for it.</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">drop</span><span class="p" data-group-id="8970986292-4">(</span><span class="o">-</span><span class="mi">1</span><span class="p" data-group-id="8970986292-4">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">tensor</span><span class="p" data-group-id="8970986292-5">(</span><span class="p" data-group-id="8970986292-5">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">divide</span><span class="p" data-group-id="8970986292-6">(</span><span class="n">characters_count</span><span class="p" data-group-id="8970986292-6">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="8970986292-7">(</span><span class="p" data-group-id="8970986292-8">{</span><span class="ss">:auto</span><span class="p">,</span><span class="w"> </span><span class="n">sequence_length</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="8970986292-8">}</span><span class="p" data-group-id="8970986292-7">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="3399352319-1">#</span><span class="nc" data-group-id="3399352319-1">Nx.Tensor</span><span class="p" data-group-id="3399352319-1">&lt;</span><span class="w">
  </span><span class="n">f32</span><span class="p" data-group-id="3399352319-2">[</span><span class="mi">155920</span><span class="p" data-group-id="3399352319-2">]</span><span class="p" data-group-id="3399352319-3">[</span><span class="mi">100</span><span class="p" data-group-id="3399352319-3">]</span><span class="p" data-group-id="3399352319-4">[</span><span class="mi">1</span><span class="p" data-group-id="3399352319-4">]</span><span class="w">
  </span><span class="nc">EXLA.Backend</span><span class="o">&lt;</span><span class="n">cuda</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1092860687</span><span class="o">.</span><span class="mf">3230269458.76811</span><span class="p" data-group-id="3399352319-1">&gt;</span><span class="w">
  </span><span class="p" data-group-id="3399352319-5">[</span><span class="w">
    </span><span class="p" data-group-id="3399352319-6">[</span><span class="w">
      </span><span class="p" data-group-id="3399352319-7">[</span><span class="mf">0.7586206793785095</span><span class="p" data-group-id="3399352319-7">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-8">[</span><span class="mf">0.3448275923728943</span><span class="p" data-group-id="3399352319-8">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-9">[</span><span class="mf">0.24137930572032928</span><span class="p" data-group-id="3399352319-9">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-10">[</span><span class="mf">0.03448275849223137</span><span class="p" data-group-id="3399352319-10">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-11">[</span><span class="mf">0.6206896305084229</span><span class="p" data-group-id="3399352319-11">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-12">[</span><span class="mf">0.6896551847457886</span><span class="p" data-group-id="3399352319-12">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-13">[</span><span class="mf">0.5862069129943848</span><span class="p" data-group-id="3399352319-13">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-14">[</span><span class="mf">0.41379308700561523</span><span class="p" data-group-id="3399352319-14">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-15">[</span><span class="mf">0.24137930572032928</span><span class="p" data-group-id="3399352319-15">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-16">[</span><span class="mf">0.17241379618644714</span><span class="p" data-group-id="3399352319-16">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-17">[</span><span class="mf">0.7586206793785095</span><span class="p" data-group-id="3399352319-17">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-18">[</span><span class="mf">0.03448275849223137</span><span class="p" data-group-id="3399352319-18">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-19">[</span><span class="mf">0.3103448152542114</span><span class="p" data-group-id="3399352319-19">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-20">[</span><span class="mf">0.7931034564971924</span><span class="p" data-group-id="3399352319-20">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-21">[</span><span class="mf">0.7586206793785095</span><span class="p" data-group-id="3399352319-21">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-22">[</span><span class="mf">0.24137930572032928</span><span class="p" data-group-id="3399352319-22">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-23">[</span><span class="mf">0.5517241358757019</span><span class="p" data-group-id="3399352319-23">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-24">[</span><span class="mf">0.13793103396892548</span><span class="p" data-group-id="3399352319-24">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-25">[</span><span class="mf">0.24137930572032928</span><span class="p" data-group-id="3399352319-25">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-26">[</span><span class="mf">0.6896551847457886</span><span class="p" data-group-id="3399352319-26">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-27">[</span><span class="mf">0.3103448152542114</span><span class="p" data-group-id="3399352319-27">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-28">[</span><span class="mf">0.03448275849223137</span><span class="p" data-group-id="3399352319-28">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-29">[</span><span class="mf">0.24137930572032928</span><span class="p" data-group-id="3399352319-29">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-30">[</span><span class="mf">0.13793103396892548</span><span class="p" data-group-id="3399352319-30">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-31">[</span><span class="mf">0.5862069129943848</span><span class="p" data-group-id="3399352319-31">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-32">[</span><span class="mf">0.5862069129943848</span><span class="p" data-group-id="3399352319-32">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-33">[</span><span class="mf">0.4482758641242981</span><span class="p" data-group-id="3399352319-33">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-34">[</span><span class="mf">0.03448275849223137</span><span class="p" data-group-id="3399352319-34">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-35">[</span><span class="mf">0.5862069129943848</span><span class="p" data-group-id="3399352319-35">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-36">[</span><span class="mf">0.27586206793785095</span><span class="p" data-group-id="3399352319-36">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-37">[</span><span class="mf">0.03448275849223137</span><span class="p" data-group-id="3399352319-37">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-38">[</span><span class="mf">0.10344827175140381</span><span class="p" data-group-id="3399352319-38">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-39">[</span><span class="mf">0.48275861144065857</span><span class="p" data-group-id="3399352319-39">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-40">[</span><span class="mf">0.37931033968925476</span><span class="p" data-group-id="3399352319-40">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-41">[</span><span class="mf">0.17241379618644714</span><span class="p" data-group-id="3399352319-41">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-42">[</span><span class="mf">0.24137930572032928</span><span class="p" data-group-id="3399352319-42">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-43">[</span><span class="mf">0.7241379022598267</span><span class="p" data-group-id="3399352319-43">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-44">[</span><span class="mf">0.03448275849223137</span><span class="p" data-group-id="3399352319-44">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-45">[</span><span class="mf">0.10344827175140381</span><span class="p" data-group-id="3399352319-45">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-46">[</span><span class="mf">0.20689654350280762</span><span class="p" data-group-id="3399352319-46">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-47">[</span><span class="mf">0.8275861740112305</span><span class="p" data-group-id="3399352319-47">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-48">[</span><span class="mf">0.24137930572032928</span><span class="p" data-group-id="3399352319-48">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-49">[</span><span class="mf">0.5517241358757019</span><span class="p" data-group-id="3399352319-49">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-50">[</span><span class="mf">0.7586206793785095</span><span class="p" data-group-id="3399352319-50">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-51">[</span><span class="mf">0.7931034564971924</span><span class="p" data-group-id="3399352319-51">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-52">[</span><span class="mf">0.6896551847457886</span><span class="p" data-group-id="3399352319-52">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-53">[</span><span class="mf">0.24137930572032928</span><span class="p" data-group-id="3399352319-53">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-54">[</span><span class="mf">0.7241379022598267</span><span class="p" data-group-id="3399352319-54">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-55">[</span><span class="mf">0.03448275849223137</span><span class="p" data-group-id="3399352319-55">]</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="3399352319-56">[</span><span class="mf">0.37931033968925476</span><span class="p" data-group-id="3399352319-56">]</span><span class="p">,</span><span class="w">
      </span><span class="n">...</span><span class="w">
    </span><span class="p" data-group-id="3399352319-6">]</span><span class="p">,</span><span class="w">
    </span><span class="n">...</span><span class="w">
  </span><span class="p" data-group-id="3399352319-5">]</span><span class="w">
</span><span class="o">&gt;</span></code></pre><p>For our train results, We will do the same. Drop the first <code class="inline">sequence_length</code> characters and then convert them to the mapping. This time we need to do something called <strong>one-hot encoding</strong>.</p><p>The reason we want to use one hot encoding is that in our model we don't want to only return a character as the output. We want it to return the possibility of each character for the output. This way we can decide if certain possibility is good or not or even we can decide between multiple possible outputs or even discard everything if the network is not confident enough.</p><p>In Nx, you can achieve this encoding by using this snippet</p><pre><code class="makeup elixir" translate="no"><span class="nc">Nx</span><span class="o">.</span><span class="n">tensor</span><span class="p" data-group-id="7857433039-1">(</span><span class="p" data-group-id="7857433039-2">[</span><span class="w">
  </span><span class="p" data-group-id="7857433039-3">[</span><span class="mi">0</span><span class="p" data-group-id="7857433039-3">]</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="7857433039-4">[</span><span class="mi">1</span><span class="p" data-group-id="7857433039-4">]</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="7857433039-5">[</span><span class="mi">2</span><span class="p" data-group-id="7857433039-5">]</span><span class="w">
</span><span class="p" data-group-id="7857433039-2">]</span><span class="p" data-group-id="7857433039-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">equal</span><span class="p" data-group-id="7857433039-6">(</span><span class="nc">Nx</span><span class="o">.</span><span class="n">iota</span><span class="p" data-group-id="7857433039-7">(</span><span class="p" data-group-id="7857433039-8">{</span><span class="mi">3</span><span class="p" data-group-id="7857433039-8">}</span><span class="p" data-group-id="7857433039-7">)</span><span class="p" data-group-id="7857433039-6">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="5944801540-1">#</span><span class="nc" data-group-id="5944801540-1">Nx.Tensor</span><span class="p" data-group-id="5944801540-1">&lt;</span><span class="w">
  </span><span class="n">u8</span><span class="p" data-group-id="5944801540-2">[</span><span class="mi">3</span><span class="p" data-group-id="5944801540-2">]</span><span class="p" data-group-id="5944801540-3">[</span><span class="mi">3</span><span class="p" data-group-id="5944801540-3">]</span><span class="w">
  </span><span class="nc">EXLA.Backend</span><span class="o">&lt;</span><span class="n">cuda</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1092860687</span><span class="o">.</span><span class="mf">3230269458.76814</span><span class="p" data-group-id="5944801540-1">&gt;</span><span class="w">
  </span><span class="p" data-group-id="5944801540-4">[</span><span class="w">
    </span><span class="p" data-group-id="5944801540-5">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="5944801540-5">]</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5944801540-6">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="5944801540-6">]</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5944801540-7">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="5944801540-7">]</span><span class="w">
  </span><span class="p" data-group-id="5944801540-4">]</span><span class="w">
</span><span class="o">&gt;</span></code></pre><p>To sum it up, Here is how we generate the train results.</p><pre><code class="makeup elixir" translate="no"><span class="n">train_results</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">normalized_book_text</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">drop</span><span class="p" data-group-id="2054930157-1">(</span><span class="n">sequence_length</span><span class="p" data-group-id="2054930157-1">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="2054930157-2">(</span><span class="o">&amp;</span><span class="nc">Map</span><span class="o">.</span><span class="n">fetch!</span><span class="p" data-group-id="2054930157-3">(</span><span class="n">char_to_idx</span><span class="p">,</span><span class="w"> </span><span class="ni">&amp;1</span><span class="p" data-group-id="2054930157-3">)</span><span class="p" data-group-id="2054930157-2">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">tensor</span><span class="p" data-group-id="2054930157-4">(</span><span class="p" data-group-id="2054930157-4">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="2054930157-5">(</span><span class="p" data-group-id="2054930157-6">{</span><span class="ss">:auto</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="2054930157-6">}</span><span class="p" data-group-id="2054930157-5">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">equal</span><span class="p" data-group-id="2054930157-7">(</span><span class="nc">Nx</span><span class="o">.</span><span class="n">iota</span><span class="p" data-group-id="2054930157-8">(</span><span class="p" data-group-id="2054930157-9">{</span><span class="n">characters_count</span><span class="p" data-group-id="2054930157-9">}</span><span class="p" data-group-id="2054930157-8">)</span><span class="p" data-group-id="2054930157-7">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="5808576416-1">#</span><span class="nc" data-group-id="5808576416-1">Nx.Tensor</span><span class="p" data-group-id="5808576416-1">&lt;</span><span class="w">
  </span><span class="n">u8</span><span class="p" data-group-id="5808576416-2">[</span><span class="mi">155920</span><span class="p" data-group-id="5808576416-2">]</span><span class="p" data-group-id="5808576416-3">[</span><span class="mi">29</span><span class="p" data-group-id="5808576416-3">]</span><span class="w">
  </span><span class="nc">EXLA.Backend</span><span class="o">&lt;</span><span class="n">cuda</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1092860687</span><span class="o">.</span><span class="mf">3230269458.76818</span><span class="p" data-group-id="5808576416-1">&gt;</span><span class="w">
  </span><span class="p" data-group-id="5808576416-4">[</span><span class="w">
    </span><span class="p" data-group-id="5808576416-5">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="5808576416-5">]</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5808576416-6">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="5808576416-6">]</span><span class="p">,</span><span class="w">
    </span><span class="n">...</span><span class="w">
  </span><span class="p" data-group-id="5808576416-4">]</span><span class="w">
</span><span class="o">&gt;</span></code></pre><h2 id="defining-the-model" class="section-heading">
  <a href="#defining-the-model" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">defining-the-model</p>
  </a>
  Defining the Model
</h2>
<pre><code class="makeup elixir" translate="no"><span class="c1"># As the input, We expect the sequence_length characters. Each one is a number.</span><span class="w">
</span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Axon</span><span class="o">.</span><span class="n">input</span><span class="p" data-group-id="5363151068-1">(</span><span class="s">&quot;input_chars&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">shape</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5363151068-2">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="n">sequence_length</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="5363151068-2">}</span><span class="p" data-group-id="5363151068-1">)</span><span class="w">
  </span><span class="c1"># The Long Short Term Memory layer of our network</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">lstm</span><span class="p" data-group-id="5363151068-3">(</span><span class="mi">256</span><span class="p" data-group-id="5363151068-3">)</span><span class="w">
  </span><span class="c1"># Selecting only the output from the LSTM Layer</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">then</span><span class="p" data-group-id="5363151068-4">(</span><span class="k" data-group-id="5363151068-5">fn</span><span class="w"> </span><span class="p" data-group-id="5363151068-6">{</span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p" data-group-id="5363151068-6">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="k" data-group-id="5363151068-5">end</span><span class="p" data-group-id="5363151068-4">)</span><span class="w">
  </span><span class="c1"># Since we only want the last sequence in LSTM we will slice it and select the last one</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">nx</span><span class="p" data-group-id="5363151068-7">(</span><span class="k" data-group-id="5363151068-8">fn</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">t</span><span class="p" data-group-id="5363151068-9">[</span><span class="p" data-group-id="5363151068-10">[</span><span class="mi">0</span><span class="o">..</span><span class="o">-</span><span class="mi">1</span><span class="o">//</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p" data-group-id="5363151068-10">]</span><span class="p" data-group-id="5363151068-9">]</span><span class="w"> </span><span class="k" data-group-id="5363151068-8">end</span><span class="p" data-group-id="5363151068-7">)</span><span class="w">
  </span><span class="c1"># 20% dropout so we will not become too dependent on specific neurons.</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dropout</span><span class="p" data-group-id="5363151068-11">(</span><span class="ss">rate</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2</span><span class="p" data-group-id="5363151068-11">)</span><span class="w">
  </span><span class="c1"># The output layer. One for each character and using softmax as activation</span><span class="w">
  </span><span class="c1"># so every node represents a probability.</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="5363151068-12">(</span><span class="n">characters_count</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:softmax</span><span class="p" data-group-id="5363151068-12">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="w">
                                                                                           </span><span class="nc">Model</span><span class="w">
</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">==</span><span class="w">
 </span><span class="nc">Layer</span><span class="w">                                                                               </span><span class="nc">Shape</span><span class="w">                                               </span><span class="nc">Policy</span><span class="w">              </span><span class="nc">Parameters</span><span class="w">   </span><span class="nc">Parameters</span><span class="w"> </span><span class="nc">Memory</span><span class="w">
</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">==</span><span class="w">
 </span><span class="n">input_chars</span><span class="w"> </span><span class="p" data-group-id="1104783088-1">(</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="p" data-group-id="1104783088-1">)</span><span class="w">                                                               </span><span class="p" data-group-id="1104783088-2">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="1104783088-2">}</span><span class="w">                                       </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">lstm__c_hidden_state</span><span class="w"> </span><span class="p" data-group-id="1104783088-3">(</span><span class="w"> </span><span class="n">recurrent_state</span><span class="p" data-group-id="1104783088-4">[</span><span class="s">&quot;input_chars&quot;</span><span class="p" data-group-id="1104783088-4">]</span><span class="w"> </span><span class="p" data-group-id="1104783088-3">)</span><span class="w">                             </span><span class="p" data-group-id="1104783088-5">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="1104783088-5">}</span><span class="w">                                       </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">lstm__h_hidden_state</span><span class="w"> </span><span class="p" data-group-id="1104783088-6">(</span><span class="w"> </span><span class="n">recurrent_state</span><span class="p" data-group-id="1104783088-7">[</span><span class="s">&quot;input_chars&quot;</span><span class="p" data-group-id="1104783088-7">]</span><span class="w"> </span><span class="p" data-group-id="1104783088-6">)</span><span class="w">                             </span><span class="p" data-group-id="1104783088-8">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="1104783088-8">}</span><span class="w">                                       </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">lstm__hidden_state</span><span class="w"> </span><span class="p" data-group-id="1104783088-9">(</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="p" data-group-id="1104783088-10">{</span><span class="s">&quot;lstm__c_hidden_state&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;lstm__h_hidden_state&quot;</span><span class="p" data-group-id="1104783088-10">}</span><span class="w"> </span><span class="p" data-group-id="1104783088-9">)</span><span class="w">   </span><span class="p" data-group-id="1104783088-11">{</span><span class="p" data-group-id="1104783088-12">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="1104783088-12">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1104783088-13">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="1104783088-13">}</span><span class="p" data-group-id="1104783088-11">}</span><span class="w">                      </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">lstm_0</span><span class="w"> </span><span class="p" data-group-id="1104783088-14">(</span><span class="w"> </span><span class="n">lstm</span><span class="p" data-group-id="1104783088-15">[</span><span class="s">&quot;input_chars&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;lstm__hidden_state&quot;</span><span class="p" data-group-id="1104783088-15">]</span><span class="w"> </span><span class="p" data-group-id="1104783088-14">)</span><span class="w">                                </span><span class="p" data-group-id="1104783088-16">{</span><span class="p" data-group-id="1104783088-17">{</span><span class="p" data-group-id="1104783088-18">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="1104783088-18">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1104783088-19">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="1104783088-19">}</span><span class="p" data-group-id="1104783088-17">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1104783088-20">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="1104783088-20">}</span><span class="p" data-group-id="1104783088-16">}</span><span class="w">   </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">264192</span><span class="w">       </span><span class="mi">1056768</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">lstm_1_output_sequence</span><span class="w"> </span><span class="p" data-group-id="1104783088-21">(</span><span class="w"> </span><span class="n">elem</span><span class="p" data-group-id="1104783088-22">[</span><span class="s">&quot;lstm_0&quot;</span><span class="p" data-group-id="1104783088-22">]</span><span class="w"> </span><span class="p" data-group-id="1104783088-21">)</span><span class="w">                                           </span><span class="p" data-group-id="1104783088-23">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="1104783088-23">}</span><span class="w">                                     </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">nx_0</span><span class="w"> </span><span class="p" data-group-id="1104783088-24">(</span><span class="w"> </span><span class="n">nx</span><span class="p" data-group-id="1104783088-25">[</span><span class="s">&quot;lstm_1_output_sequence&quot;</span><span class="p" data-group-id="1104783088-25">]</span><span class="w"> </span><span class="p" data-group-id="1104783088-24">)</span><span class="w">                                               </span><span class="p" data-group-id="1104783088-26">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="1104783088-26">}</span><span class="w">                                          </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">dropout_0</span><span class="w"> </span><span class="p" data-group-id="1104783088-27">(</span><span class="w"> </span><span class="n">dropout</span><span class="p" data-group-id="1104783088-28">[</span><span class="s">&quot;nx_0&quot;</span><span class="p" data-group-id="1104783088-28">]</span><span class="w"> </span><span class="p" data-group-id="1104783088-27">)</span><span class="w">                                                       </span><span class="p" data-group-id="1104783088-29">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="1104783088-29">}</span><span class="w">                                          </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">dense_0</span><span class="w"> </span><span class="p" data-group-id="1104783088-30">(</span><span class="w"> </span><span class="n">dense</span><span class="p" data-group-id="1104783088-31">[</span><span class="s">&quot;dropout_0&quot;</span><span class="p" data-group-id="1104783088-31">]</span><span class="w"> </span><span class="p" data-group-id="1104783088-30">)</span><span class="w">                                                      </span><span class="p" data-group-id="1104783088-32">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="p" data-group-id="1104783088-32">}</span><span class="w">                                           </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">7453</span><span class="w">         </span><span class="mi">29812</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">softmax_0</span><span class="w"> </span><span class="p" data-group-id="1104783088-33">(</span><span class="w"> </span><span class="n">softmax</span><span class="p" data-group-id="1104783088-34">[</span><span class="s">&quot;dense_0&quot;</span><span class="p" data-group-id="1104783088-34">]</span><span class="w"> </span><span class="p" data-group-id="1104783088-33">)</span><span class="w">                                                    </span><span class="p" data-group-id="1104783088-35">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="p" data-group-id="1104783088-35">}</span><span class="w">                                           </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="w">
</span><span class="nc">Total</span><span class="w"> </span><span class="ss">Parameters</span><span class="p">:</span><span class="w"> </span><span class="mi">271645</span><span class="w">
</span><span class="nc">Total</span><span class="w"> </span><span class="nc">Parameters</span><span class="w"> </span><span class="ss">Memory</span><span class="p">:</span><span class="w"> </span><span class="mi">1086580</span><span class="w"> </span><span class="n">bytes</span><span class="w">
</span><span class="ss">Inputs</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1104783088-36">%{</span><span class="s">&quot;input_chars&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1104783088-37">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="1104783088-37">}</span><span class="p" data-group-id="1104783088-36">}</span><span class="w">
</span></code></pre><h2 id="training-the-network" class="section-heading">
  <a href="#training-the-network" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">training-the-network</p>
  </a>
  Training the network
</h2>
<p>To train the network, We will use Axon's Loop API. It is pretty straightforward.</p><p>For the loss function we can use <code class="inline">categorical_cross_entropy</code> since we are dealing as categories (each character) in our output and for the optimizer we can use <code class="inline">adam</code>.</p><p>We will train our network for 20 epochs and it will take some time depending on your machine. It is faster to run this with a GPU.</p><pre><code class="makeup elixir" translate="no"><span class="n">batch_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="w">
</span><span class="n">train_batches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_batched_list</span><span class="p" data-group-id="6079657025-1">(</span><span class="n">train_data</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="p" data-group-id="6079657025-1">)</span><span class="w">
</span><span class="n">result_batches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_batched_list</span><span class="p" data-group-id="6079657025-2">(</span><span class="n">train_results</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="p" data-group-id="6079657025-2">)</span><span class="w">

</span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="6079657025-3">(</span><span class="s">&quot;Total batches: </span><span class="si" data-group-id="6079657025-4">#{</span><span class="nc">Enum</span><span class="o">.</span><span class="n">count</span><span class="p" data-group-id="6079657025-5">(</span><span class="n">train_batches</span><span class="p" data-group-id="6079657025-5">)</span><span class="si" data-group-id="6079657025-4">}</span><span class="s">&quot;</span><span class="p" data-group-id="6079657025-3">)</span><span class="w">

</span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">model</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">trainer</span><span class="p" data-group-id="6079657025-6">(</span><span class="ss">:categorical_cross_entropy</span><span class="p">,</span><span class="w"> </span><span class="nc">Axon.Optimizers</span><span class="o">.</span><span class="n">adam</span><span class="p" data-group-id="6079657025-7">(</span><span class="mf">0.001</span><span class="p" data-group-id="6079657025-7">)</span><span class="p" data-group-id="6079657025-6">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="6079657025-8">(</span><span class="nc">Stream</span><span class="o">.</span><span class="n">zip</span><span class="p" data-group-id="6079657025-9">(</span><span class="n">train_batches</span><span class="p">,</span><span class="w"> </span><span class="n">result_batches</span><span class="p" data-group-id="6079657025-9">)</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6079657025-10">%{</span><span class="p" data-group-id="6079657025-10">}</span><span class="p">,</span><span class="w"> </span><span class="ss">epochs</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="ss">compiler</span><span class="p">:</span><span class="w"> </span><span class="nc">EXLA</span><span class="p" data-group-id="6079657025-8">)</span><span class="w">

</span><span class="ss">:ok</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="nc">Total</span><span class="w"> </span><span class="ss">batches</span><span class="p">:</span><span class="w"> </span><span class="mi">1219</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.8182118</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.7643051</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.7256687</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.6924984</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.6610374</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.6315992</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.6038766</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.5778201</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.5536559</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.5307744</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.5094700</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.4894619</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.4707501</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.4531305</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.4365997</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.4208741</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.4061375</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.3922462</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.3791831</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.3668413</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="ss">:ok</span></code></pre><h2 id="generating-text" class="section-heading">
  <a href="#generating-text" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">generating-text</p>
  </a>
  Generating text
</h2>
<p>After last step we will have our trained network parameters so we can start generating text with it. We simply need to give the initial sequence as the input to the network and select the most confident output. <a href="Axon.html#predict/3"><code class="inline">Axon.predict/3</code></a> will give us the output layer and then using <a href="https://hexdocs.pm/nx/0.3.0/Nx.html#argmax/1"><code class="inline">Nx.argmax/1</code></a> we get the most confident neuron index then simply convert that index back to it's Unicode representation.</p><pre><code class="makeup elixir" translate="no"><span class="kn">require</span><span class="w"> </span><span class="nc">Axon</span><span class="w">

</span><span class="n">generate_fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="7428142692-1">fn</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">init_seq</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="c1"># The initial sequence that we want the network to complete for us.</span><span class="w">
  </span><span class="n">init_seq</span><span class="w"> </span><span class="o">=</span><span class="w">
    </span><span class="n">init_seq</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">trim</span><span class="p" data-group-id="7428142692-2">(</span><span class="p" data-group-id="7428142692-2">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">downcase</span><span class="p" data-group-id="7428142692-3">(</span><span class="p" data-group-id="7428142692-3">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">to_charlist</span><span class="p" data-group-id="7428142692-4">(</span><span class="p" data-group-id="7428142692-4">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="7428142692-5">(</span><span class="o">&amp;</span><span class="nc">Map</span><span class="o">.</span><span class="n">fetch!</span><span class="p" data-group-id="7428142692-6">(</span><span class="n">char_to_idx</span><span class="p">,</span><span class="w"> </span><span class="ni">&amp;1</span><span class="p" data-group-id="7428142692-6">)</span><span class="p" data-group-id="7428142692-5">)</span><span class="w">

  </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p" data-group-id="7428142692-7">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">init_seq</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="7428142692-8">fn</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="n">init_seq</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">seq</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">take</span><span class="p" data-group-id="7428142692-9">(</span><span class="o">-</span><span class="n">sequence_length</span><span class="p" data-group-id="7428142692-9">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">tensor</span><span class="p" data-group-id="7428142692-10">(</span><span class="p" data-group-id="7428142692-10">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">divide</span><span class="p" data-group-id="7428142692-11">(</span><span class="n">characters_count</span><span class="p" data-group-id="7428142692-11">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="7428142692-12">(</span><span class="p" data-group-id="7428142692-13">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">sequence_length</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="7428142692-13">}</span><span class="p" data-group-id="7428142692-12">)</span><span class="w">

    </span><span class="n">char</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="nc">Axon</span><span class="o">.</span><span class="n">predict</span><span class="p" data-group-id="7428142692-14">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">init_seq</span><span class="p" data-group-id="7428142692-14">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">argmax</span><span class="p" data-group-id="7428142692-15">(</span><span class="p" data-group-id="7428142692-15">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_number</span><span class="p" data-group-id="7428142692-16">(</span><span class="p" data-group-id="7428142692-16">)</span><span class="w">

    </span><span class="n">seq</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="7428142692-17">[</span><span class="n">char</span><span class="p" data-group-id="7428142692-17">]</span><span class="w">
  </span><span class="k" data-group-id="7428142692-8">end</span><span class="p" data-group-id="7428142692-7">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="7428142692-18">(</span><span class="o">&amp;</span><span class="nc">Map</span><span class="o">.</span><span class="n">fetch!</span><span class="p" data-group-id="7428142692-19">(</span><span class="n">idx_to_char</span><span class="p">,</span><span class="w"> </span><span class="ni">&amp;1</span><span class="p" data-group-id="7428142692-19">)</span><span class="p" data-group-id="7428142692-18">)</span><span class="w">
</span><span class="k" data-group-id="7428142692-1">end</span><span class="w">

</span><span class="c1"># The initial sequence that we want the network to complete for us.</span><span class="w">
</span><span class="n">init_seq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
not like to drop the jar for fear
of killing somebody underneath so managed to put it into one of the
cupboards as she fell past it.
&quot;&quot;&quot;</span><span class="w">

</span><span class="n">generate_fn</span><span class="o">.</span><span class="p" data-group-id="7428142692-20">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">init_seq</span><span class="p" data-group-id="7428142692-20">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="7428142692-21">(</span><span class="p" data-group-id="7428142692-21">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="ow">not</span><span class="w"> </span><span class="n">like</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">drop</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">jar</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">fear</span><span class="w">
</span><span class="n">of</span><span class="w"> </span><span class="n">killing</span><span class="w"> </span><span class="n">somebody</span><span class="w"> </span><span class="n">underneath</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">managed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">put</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w">
</span><span class="n">cupboards</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">she</span><span class="w"> </span><span class="n">fell</span><span class="w"> </span><span class="n">past</span><span class="w"> </span><span class="n">it</span><span class="o">.</span><span class="n">aty</span><span class="w"> </span><span class="n">arh</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">coec</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">tee</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">project</span><span class="w"> </span><span class="n">gutenbergtm</span><span class="w"> </span><span class="n">electronic</span><span class="w"> </span><span class="n">worn</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">project</span><span class="w"> </span><span class="n">gutenbergtm</span><span class="w"> </span><span class="n">ele</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="ss">:ok</span></code></pre><h2 id="multi-lstm-layers" class="section-heading">
  <a href="#multi-lstm-layers" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">multi-lstm-layers</p>
  </a>
  Multi LSTM layers
</h2>
<p>We can improve our network by stacking multiple LSTM layers together. We just need to change our model and re-train our network.</p><pre><code class="makeup elixir" translate="no"><span class="n">new_model</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Axon</span><span class="o">.</span><span class="n">input</span><span class="p" data-group-id="6108766155-1">(</span><span class="s">&quot;input_chars&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">shape</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6108766155-2">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="n">sequence_length</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="6108766155-2">}</span><span class="p" data-group-id="6108766155-1">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">lstm</span><span class="p" data-group-id="6108766155-3">(</span><span class="mi">256</span><span class="p" data-group-id="6108766155-3">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">then</span><span class="p" data-group-id="6108766155-4">(</span><span class="k" data-group-id="6108766155-5">fn</span><span class="w"> </span><span class="p" data-group-id="6108766155-6">{</span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p" data-group-id="6108766155-6">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="k" data-group-id="6108766155-5">end</span><span class="p" data-group-id="6108766155-4">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dropout</span><span class="p" data-group-id="6108766155-7">(</span><span class="ss">rate</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2</span><span class="p" data-group-id="6108766155-7">)</span><span class="w">
  </span><span class="c1"># This time we will pass all of the `out` to the next lstm layer.</span><span class="w">
  </span><span class="c1"># We just need to slice the last one.</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">lstm</span><span class="p" data-group-id="6108766155-8">(</span><span class="mi">256</span><span class="p" data-group-id="6108766155-8">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">then</span><span class="p" data-group-id="6108766155-9">(</span><span class="k" data-group-id="6108766155-10">fn</span><span class="w"> </span><span class="p" data-group-id="6108766155-11">{</span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p" data-group-id="6108766155-11">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="k" data-group-id="6108766155-10">end</span><span class="p" data-group-id="6108766155-9">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">nx</span><span class="p" data-group-id="6108766155-12">(</span><span class="k" data-group-id="6108766155-13">fn</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="p" data-group-id="6108766155-14">[</span><span class="p" data-group-id="6108766155-15">[</span><span class="mi">0</span><span class="o">..</span><span class="o">-</span><span class="mi">1</span><span class="o">//</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p" data-group-id="6108766155-15">]</span><span class="p" data-group-id="6108766155-14">]</span><span class="w"> </span><span class="k" data-group-id="6108766155-13">end</span><span class="p" data-group-id="6108766155-12">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dropout</span><span class="p" data-group-id="6108766155-16">(</span><span class="ss">rate</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2</span><span class="p" data-group-id="6108766155-16">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="6108766155-17">(</span><span class="n">characters_count</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:softmax</span><span class="p" data-group-id="6108766155-17">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">-</span><span class="w">
                                                                                             </span><span class="nc">Model</span><span class="w">
</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">==</span><span class="w">
 </span><span class="nc">Layer</span><span class="w">                                                                                  </span><span class="nc">Shape</span><span class="w">                                               </span><span class="nc">Policy</span><span class="w">              </span><span class="nc">Parameters</span><span class="w">   </span><span class="nc">Parameters</span><span class="w"> </span><span class="nc">Memory</span><span class="w">
</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">===</span><span class="o">==</span><span class="w">
 </span><span class="n">input_chars</span><span class="w"> </span><span class="p" data-group-id="8530173499-1">(</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="p" data-group-id="8530173499-1">)</span><span class="w">                                                                  </span><span class="p" data-group-id="8530173499-2">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="8530173499-2">}</span><span class="w">                                       </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">lstm__c_hidden_state</span><span class="w"> </span><span class="p" data-group-id="8530173499-3">(</span><span class="w"> </span><span class="n">recurrent_state</span><span class="p" data-group-id="8530173499-4">[</span><span class="s">&quot;input_chars&quot;</span><span class="p" data-group-id="8530173499-4">]</span><span class="w"> </span><span class="p" data-group-id="8530173499-3">)</span><span class="w">                                </span><span class="p" data-group-id="8530173499-5">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-5">}</span><span class="w">                                       </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">lstm__h_hidden_state</span><span class="w"> </span><span class="p" data-group-id="8530173499-6">(</span><span class="w"> </span><span class="n">recurrent_state</span><span class="p" data-group-id="8530173499-7">[</span><span class="s">&quot;input_chars&quot;</span><span class="p" data-group-id="8530173499-7">]</span><span class="w"> </span><span class="p" data-group-id="8530173499-6">)</span><span class="w">                                </span><span class="p" data-group-id="8530173499-8">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-8">}</span><span class="w">                                       </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">lstm__hidden_state</span><span class="w"> </span><span class="p" data-group-id="8530173499-9">(</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="p" data-group-id="8530173499-10">{</span><span class="s">&quot;lstm__c_hidden_state&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;lstm__h_hidden_state&quot;</span><span class="p" data-group-id="8530173499-10">}</span><span class="w"> </span><span class="p" data-group-id="8530173499-9">)</span><span class="w">      </span><span class="p" data-group-id="8530173499-11">{</span><span class="p" data-group-id="8530173499-12">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-12">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8530173499-13">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-13">}</span><span class="p" data-group-id="8530173499-11">}</span><span class="w">                      </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">lstm_0</span><span class="w"> </span><span class="p" data-group-id="8530173499-14">(</span><span class="w"> </span><span class="n">lstm</span><span class="p" data-group-id="8530173499-15">[</span><span class="s">&quot;input_chars&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;lstm__hidden_state&quot;</span><span class="p" data-group-id="8530173499-15">]</span><span class="w"> </span><span class="p" data-group-id="8530173499-14">)</span><span class="w">                                   </span><span class="p" data-group-id="8530173499-16">{</span><span class="p" data-group-id="8530173499-17">{</span><span class="p" data-group-id="8530173499-18">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-18">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8530173499-19">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-19">}</span><span class="p" data-group-id="8530173499-17">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8530173499-20">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-20">}</span><span class="p" data-group-id="8530173499-16">}</span><span class="w">   </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">264192</span><span class="w">       </span><span class="mi">1056768</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">lstm_1_output_sequence</span><span class="w"> </span><span class="p" data-group-id="8530173499-21">(</span><span class="w"> </span><span class="n">elem</span><span class="p" data-group-id="8530173499-22">[</span><span class="s">&quot;lstm_0&quot;</span><span class="p" data-group-id="8530173499-22">]</span><span class="w"> </span><span class="p" data-group-id="8530173499-21">)</span><span class="w">                                              </span><span class="p" data-group-id="8530173499-23">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-23">}</span><span class="w">                                     </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">dropout_0</span><span class="w"> </span><span class="p" data-group-id="8530173499-24">(</span><span class="w"> </span><span class="n">dropout</span><span class="p" data-group-id="8530173499-25">[</span><span class="s">&quot;lstm_1_output_sequence&quot;</span><span class="p" data-group-id="8530173499-25">]</span><span class="w"> </span><span class="p" data-group-id="8530173499-24">)</span><span class="w">                                        </span><span class="p" data-group-id="8530173499-26">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-26">}</span><span class="w">                                     </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">lstm_1_c_hidden_state</span><span class="w"> </span><span class="p" data-group-id="8530173499-27">(</span><span class="w"> </span><span class="n">recurrent_state</span><span class="p" data-group-id="8530173499-28">[</span><span class="s">&quot;dropout_0&quot;</span><span class="p" data-group-id="8530173499-28">]</span><span class="w"> </span><span class="p" data-group-id="8530173499-27">)</span><span class="w">                                 </span><span class="p" data-group-id="8530173499-29">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-29">}</span><span class="w">                                       </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">lstm_1_h_hidden_state</span><span class="w"> </span><span class="p" data-group-id="8530173499-30">(</span><span class="w"> </span><span class="n">recurrent_state</span><span class="p" data-group-id="8530173499-31">[</span><span class="s">&quot;dropout_0&quot;</span><span class="p" data-group-id="8530173499-31">]</span><span class="w"> </span><span class="p" data-group-id="8530173499-30">)</span><span class="w">                                 </span><span class="p" data-group-id="8530173499-32">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-32">}</span><span class="w">                                       </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">lstm_1_hidden_state</span><span class="w"> </span><span class="p" data-group-id="8530173499-33">(</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="p" data-group-id="8530173499-34">{</span><span class="s">&quot;lstm_1_c_hidden_state&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;lstm_1_h_hidden_state&quot;</span><span class="p" data-group-id="8530173499-34">}</span><span class="w"> </span><span class="p" data-group-id="8530173499-33">)</span><span class="w">   </span><span class="p" data-group-id="8530173499-35">{</span><span class="p" data-group-id="8530173499-36">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-36">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8530173499-37">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-37">}</span><span class="p" data-group-id="8530173499-35">}</span><span class="w">                      </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">lstm_1</span><span class="w"> </span><span class="p" data-group-id="8530173499-38">(</span><span class="w"> </span><span class="n">lstm</span><span class="p" data-group-id="8530173499-39">[</span><span class="s">&quot;dropout_0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;lstm_1_hidden_state&quot;</span><span class="p" data-group-id="8530173499-39">]</span><span class="w"> </span><span class="p" data-group-id="8530173499-38">)</span><span class="w">                                    </span><span class="p" data-group-id="8530173499-40">{</span><span class="p" data-group-id="8530173499-41">{</span><span class="p" data-group-id="8530173499-42">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-42">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8530173499-43">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-43">}</span><span class="p" data-group-id="8530173499-41">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8530173499-44">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-44">}</span><span class="p" data-group-id="8530173499-40">}</span><span class="w">   </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">525312</span><span class="w">       </span><span class="mi">2101248</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">lstm_2_output_sequence</span><span class="w"> </span><span class="p" data-group-id="8530173499-45">(</span><span class="w"> </span><span class="n">elem</span><span class="p" data-group-id="8530173499-46">[</span><span class="s">&quot;lstm_1&quot;</span><span class="p" data-group-id="8530173499-46">]</span><span class="w"> </span><span class="p" data-group-id="8530173499-45">)</span><span class="w">                                              </span><span class="p" data-group-id="8530173499-47">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-47">}</span><span class="w">                                     </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">nx_0</span><span class="w"> </span><span class="p" data-group-id="8530173499-48">(</span><span class="w"> </span><span class="n">nx</span><span class="p" data-group-id="8530173499-49">[</span><span class="s">&quot;lstm_2_output_sequence&quot;</span><span class="p" data-group-id="8530173499-49">]</span><span class="w"> </span><span class="p" data-group-id="8530173499-48">)</span><span class="w">                                                  </span><span class="p" data-group-id="8530173499-50">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-50">}</span><span class="w">                                          </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">dropout_1</span><span class="w"> </span><span class="p" data-group-id="8530173499-51">(</span><span class="w"> </span><span class="n">dropout</span><span class="p" data-group-id="8530173499-52">[</span><span class="s">&quot;nx_0&quot;</span><span class="p" data-group-id="8530173499-52">]</span><span class="w"> </span><span class="p" data-group-id="8530173499-51">)</span><span class="w">                                                          </span><span class="p" data-group-id="8530173499-53">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="8530173499-53">}</span><span class="w">                                          </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">dense_0</span><span class="w"> </span><span class="p" data-group-id="8530173499-54">(</span><span class="w"> </span><span class="n">dense</span><span class="p" data-group-id="8530173499-55">[</span><span class="s">&quot;dropout_1&quot;</span><span class="p" data-group-id="8530173499-55">]</span><span class="w"> </span><span class="p" data-group-id="8530173499-54">)</span><span class="w">                                                         </span><span class="p" data-group-id="8530173499-56">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="p" data-group-id="8530173499-56">}</span><span class="w">                                           </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">7453</span><span class="w">         </span><span class="mi">29812</span><span class="w"> </span><span class="n">bytes</span><span class="w">
 </span><span class="n">softmax_0</span><span class="w"> </span><span class="p" data-group-id="8530173499-57">(</span><span class="w"> </span><span class="n">softmax</span><span class="p" data-group-id="8530173499-58">[</span><span class="s">&quot;dense_0&quot;</span><span class="p" data-group-id="8530173499-58">]</span><span class="w"> </span><span class="p" data-group-id="8530173499-57">)</span><span class="w">                                                       </span><span class="p" data-group-id="8530173499-59">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="p" data-group-id="8530173499-59">}</span><span class="w">                                           </span><span class="n">p</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">f32</span><span class="w"> </span><span class="n">o</span><span class="o">=</span><span class="n">f32</span><span class="w">   </span><span class="mi">0</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="n">bytes</span><span class="w">
</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">-</span><span class="w">
</span><span class="nc">Total</span><span class="w"> </span><span class="ss">Parameters</span><span class="p">:</span><span class="w"> </span><span class="mi">796957</span><span class="w">
</span><span class="nc">Total</span><span class="w"> </span><span class="nc">Parameters</span><span class="w"> </span><span class="ss">Memory</span><span class="p">:</span><span class="w"> </span><span class="mi">3187828</span><span class="w"> </span><span class="n">bytes</span><span class="w">
</span><span class="ss">Inputs</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8530173499-60">%{</span><span class="s">&quot;input_chars&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="8530173499-61">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="8530173499-61">}</span><span class="p" data-group-id="8530173499-60">}</span><span class="w">
</span></code></pre><p>Then we can train the network using the exact same code as before</p><pre><code class="makeup elixir" translate="no"><span class="c1"># Using a smaller batch size in this case will give the network more opportunity to learn</span><span class="w">
</span><span class="n">batch_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="w">
</span><span class="n">train_batches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_batched_list</span><span class="p" data-group-id="3222521856-1">(</span><span class="n">train_data</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="p" data-group-id="3222521856-1">)</span><span class="w">
</span><span class="n">result_batches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_batched_list</span><span class="p" data-group-id="3222521856-2">(</span><span class="n">train_results</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="p" data-group-id="3222521856-2">)</span><span class="w">

</span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="3222521856-3">(</span><span class="s">&quot;Total batches: </span><span class="si" data-group-id="3222521856-4">#{</span><span class="nc">Enum</span><span class="o">.</span><span class="n">count</span><span class="p" data-group-id="3222521856-5">(</span><span class="n">train_batches</span><span class="p" data-group-id="3222521856-5">)</span><span class="si" data-group-id="3222521856-4">}</span><span class="s">&quot;</span><span class="p" data-group-id="3222521856-3">)</span><span class="w">

</span><span class="n">new_params</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">new_model</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">trainer</span><span class="p" data-group-id="3222521856-6">(</span><span class="ss">:categorical_cross_entropy</span><span class="p">,</span><span class="w"> </span><span class="nc">Axon.Optimizers</span><span class="o">.</span><span class="n">adam</span><span class="p" data-group-id="3222521856-7">(</span><span class="mf">0.001</span><span class="p" data-group-id="3222521856-7">)</span><span class="p" data-group-id="3222521856-6">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="3222521856-8">(</span><span class="nc">Stream</span><span class="o">.</span><span class="n">zip</span><span class="p" data-group-id="3222521856-9">(</span><span class="n">train_batches</span><span class="p">,</span><span class="w"> </span><span class="n">result_batches</span><span class="p" data-group-id="3222521856-9">)</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3222521856-10">%{</span><span class="p" data-group-id="3222521856-10">}</span><span class="p">,</span><span class="w"> </span><span class="ss">epochs</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="ss">compiler</span><span class="p">:</span><span class="w"> </span><span class="nc">EXLA</span><span class="p" data-group-id="3222521856-8">)</span><span class="w">

</span><span class="ss">:ok</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="nc">Total</span><span class="w"> </span><span class="ss">batches</span><span class="p">:</span><span class="w"> </span><span class="mi">2437</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.6059778</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.4498167</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.3533349</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.2811732</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.2224922</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.1729276</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.1301043</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.0929463</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.0600429</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.0308213</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">2.0048594</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.9810826</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.9595370</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.9399362</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.9219711</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.9055365</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.8901759</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.8759004</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.8626444</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.8501121</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.8386080</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.8277082</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.8173727</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.8076453</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7987509</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7901217</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7818677</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">27</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7738990</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7662609</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">29</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7591102</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7523022</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">31</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7456987</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7394242</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">33</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7333591</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">34</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7274810</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">35</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7218159</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">36</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7164260</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">37</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7111731</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">38</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7061847</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">39</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.7012498</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.6966366</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">41</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.6921319</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.6876395</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">43</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.6834700</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.6793612</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.6752253</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">46</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.6712373</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">47</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.6673778</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">48</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.6635668</span><span class="w">
</span><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">1.6598836</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="ss">:ok</span></code></pre><h2 id="generate-text-with-the-new-network" class="section-heading">
  <a href="#generate-text-with-the-new-network" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">generate-text-with-the-new-network</p>
  </a>
  Generate text with the new network
</h2>
<pre><code class="makeup elixir" translate="no"><span class="n">generate_fn</span><span class="o">.</span><span class="p" data-group-id="3313890257-1">(</span><span class="n">new_model</span><span class="p">,</span><span class="w"> </span><span class="n">new_params</span><span class="p">,</span><span class="w"> </span><span class="n">init_seq</span><span class="p" data-group-id="3313890257-1">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="3313890257-2">(</span><span class="p" data-group-id="3313890257-2">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="ow">not</span><span class="w"> </span><span class="n">like</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">drop</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">jar</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">fear</span><span class="w">
</span><span class="n">of</span><span class="w"> </span><span class="n">killing</span><span class="w"> </span><span class="n">somebody</span><span class="w"> </span><span class="n">underneath</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">managed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">put</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w">
</span><span class="n">cupboards</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">she</span><span class="w"> </span><span class="n">fell</span><span class="w"> </span><span class="n">past</span><span class="w"> </span><span class="n">it</span><span class="o">.</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">project</span><span class="w"> </span><span class="n">gutenbergtm</span><span class="w"> </span><span class="n">electronic</span><span class="w"> </span><span class="n">works</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">part</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">project</span><span class="w"> </span><span class="n">gutenbergtm</span><span class="w"> </span><span class="n">electronic</span><span class="w"> </span><span class="n">works</span><span class="w">
</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="ss">:ok</span></code></pre><p>As you may see, It improved a lot with this new model and the extensive training. This time it knows about rules like adding a space after period.</p><h2 id="references" class="section-heading">
  <a href="#references" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">references</p>
  </a>
  References
</h2>
<p>The above example was written heavily inspired by <a href="https://machinelearningmastery.com/text-generation-lstm-recurrent-neural-networks-python-keras/">this article</a> by Jason Brownlee.</p>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="horses_or_humans.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Classifying horses and humans
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="credit_card_fraud.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Classifying fraudulent transactions
        </span>
      </a>

  </div>
</div>

      <footer class="footer">

          <p>
            On Hex.pm:

            <span class="line">
              <a href="https://hex.pm/packages/axon/0.2.0" class="line footer-hex-package">Package</a>
              <a href="https://preview.hex.pm/preview/axon/0.2.0" class="line">Preview</a>

                <a href="https://preview.hex.pm/preview/axon/0.2.0/show/notebooks/text/text_generator.livemd">(current file)</a>

            </span>

            <button class="line footer-button display-quick-switch">
              Search
            </button>
          </p>

        <p>
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.28.5) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</section>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css" integrity="sha384-t5CR+zwDAROtph0PXGte6ia8heboACF9R5l/DiY+WZ3P2lxNgvJkQk5n7GPvLMYw" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js" integrity="sha384-FaFLTlohFghEIZkw6VGwmf9ISTubWAVYW8tG8+w2LAIftJEULZABrF9PPFv+tVkH" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js" integrity="sha384-bHBqxz8fokvgoJ/sc17HODNxa42TlaEhB+w8ZJXTc2nZf1VgEaFZeZvT4Mznfz0v" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
      ]
    });
  });
</script>

  </body>
</html>
